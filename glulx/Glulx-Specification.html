<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Andrew Plotkin">
<title>Glulx, A 32-Bit Virtual Machine for IF</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Glulx, A 32-Bit Virtual Machine for IF</h1>
<div class="details">
<span id="author" class="author">Andrew Plotkin</span><br>
<span id="email" class="email"><a href="mailto:erkyrath@eblong.com">erkyrath@eblong.com</a></span><br>
<span id="revnumber">version 3.1.2,</span>
<span id="revdate">2010-08-17</span>
<br><span id="revremark">AsciiDoc Draft v1 (2012-02-26)</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#_why_bother">Why Bother?</a></li>
<li><a href="#_glulx_and_other_if_systems">Glulx and Other IF Systems</a></li>
<li><a href="#_credits">Credits</a></li>
</ul>
</li>
<li><a href="#_the_machine">1. The Machine</a>
<ul class="sectlevel2">
<li><a href="#_input_and_output">1.1. Input and Output</a></li>
<li><a href="#_the_memory_map">1.2. The Memory Map</a></li>
<li><a href="#_the_stack">1.3. The Stack</a>
<ul class="sectlevel3">
<li><a href="#_the_call_frame">1.3.1. The Call Frame</a></li>
<li><a href="#_call_stubs">1.3.2. Call Stubs</a></li>
<li><a href="#_calling_and_returning">1.3.3. Calling and Returning</a></li>
<li><a href="#_calling_and_returning_within_strings">1.3.4. Calling and Returning Within Strings</a></li>
<li><a href="#_calling_and_returning_during_output_filtering">1.3.5. Calling and Returning During Output Filtering</a></li>
</ul>
</li>
<li><a href="#_the_header">1.4. The Header</a></li>
<li><a href="#_instruction_format">1.5. Instruction Format</a></li>
<li><a href="#_typable_objects">1.6. Typable Objects</a>
<ul class="sectlevel3">
<li><a href="#_strings">1.6.1. Strings</a>
<ul class="sectlevel4">
<li><a href="#_unencoded_strings">1.6.1.1. Unencoded strings</a></li>
<li><a href="#_unencoded_unicode_strings">1.6.1.2. Unencoded Unicode strings</a></li>
<li><a href="#_compressed_strings">1.6.1.3. Compressed strings</a></li>
<li><a href="#_the_string_decoding_table">1.6.1.4. The String-Decoding Table</a></li>
</ul>
</li>
<li><a href="#_functions">1.6.2. Functions</a></li>
<li><a href="#_other_glulx_objects">1.6.3. Other Glulx Objects</a></li>
<li><a href="#_user_defined_objects">1.6.4. User-Defined Objects</a></li>
</ul>
</li>
<li><a href="#_floating_point_numbers">1.7. Floating-Point Numbers</a></li>
<li><a href="#_the_save_game_format">1.8. The Save-Game Format</a>
<ul class="sectlevel3">
<li><a href="#_contents_of_dynamic_memory">1.8.1. Contents of Dynamic Memory</a></li>
<li><a href="#_contents_of_the_stack">1.8.2. Contents of the Stack</a></li>
<li><a href="#_memory_allocation_heap">1.8.3. Memory Allocation Heap</a></li>
<li><a href="#_associated_story_file">1.8.4. Associated Story File</a></li>
<li><a href="#_state_not_saved">1.8.5. State Not Saved</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_dictionary_of_opcodes">2. Dictionary of Opcodes</a>
<ul class="sectlevel2">
<li><a href="#_integer_math">2.1. Integer Math</a></li>
<li><a href="#_branches">2.2. Branches</a></li>
<li><a href="#_moving_data">2.3. Moving Data</a></li>
<li><a href="#_array_data">2.4. Array Data</a></li>
<li><a href="#_the_stack_2">2.5. The Stack</a></li>
<li><a href="#_functions_2">2.6. Functions</a></li>
<li><a href="#_continuations">2.7. Continuations</a></li>
<li><a href="#_memory_map">2.8. Memory Map</a></li>
<li><a href="#Memory-Allocation-Heap-2">2.9. Memory Allocation Heap</a></li>
<li><a href="#_game_state">2.10. Game State</a></li>
<li><a href="#Output">2.11. Output</a></li>
<li><a href="#_floating_point_math">2.12. Floating-Point Math</a></li>
<li><a href="#_floating_point_comparisons">2.13. Floating-Point Comparisons</a></li>
<li><a href="#_random_number_generator">2.14. Random Number Generator</a></li>
<li><a href="#_block_copy_and_clear">2.15. Block Copy and Clear</a></li>
<li><a href="#_searching">2.16. Searching</a></li>
<li><a href="#_accelerated_functions">2.17. Accelerated Functions</a></li>
<li><a href="#_miscellaneous">2.18. Miscellaneous</a></li>
<li><a href="#_assembly_language">2.19. Assembly Language</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>VM specification version 3.1.2</p>
</div>
<div class="paragraph">
<p>Andrew Plotkin &lt;<a href="mailto:erkyrath@eblong.com">erkyrath@eblong.com</a>&gt;</p>
</div>
<div class="paragraph">
<p>Copyright 1999-2014 by Andrew Plotkin.
This specification is licensed under a Creative Commons Attribution-Noncommercial-Share Alike 3.0 Unported License: <a href="https://creativecommons.org/licenses/by-nc-sa/3.0" class="bare" target="_blank" rel="noopener">https://creativecommons.org/licenses/by-nc-sa/3.0</a></p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Ported to AsciiDoc by Tristano Ajmone.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This AsciiDoc version of the Glulx Specification is still a WIP draft!</p>
</div>
<div class="paragraph">
<p>Draft version 1, updated on 2012-02-26.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The virtual machine <em>described</em> by this document is an idea, not an expression of an idea, and is therefore not copyrightable.
Anyone is free to write programs that run on the Glulx VM or make use of it, including compilers, interpreters, debuggers, and so on.</p>
</div>
<div class="paragraph">
<p>This document and further Glulx information can be found at: <a href="https://eblong.com/zarf/glulx/" class="bare" target="_blank" rel="noopener">https://eblong.com/zarf/glulx/</a></p>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Glulx is a simple solution to a fairly trivial problem.
We want a virtual machine which the Inform compiler can compile to, without the increasingly annoying restrictions of the Z-machine.</p>
</div>
<div class="paragraph">
<p>Glulx does this, without much fuss.
All arithmetic is 32-bit (although there are opcodes to handle 8-bit and 16-bit memory access.)
Input and output are handled through the Glk API (which chops out half the Z-machine opcodes, and most of the complexity of a Z-code interpreter.)
Some care has been taken to make the bytecode small, but simplicity and elbow room are considered more important&#8201;&#8212;&#8201;bytecode is not a majority of the bulk in current Inform games.</p>
</div>
<div class="sect2">
<h3 id="_why_bother"><a class="anchor" href="#_why_bother"></a>Why Bother?</h3>
<div class="paragraph">
<p>We&#8217;re buried in IF VMs already, not to mention general VMs like Java, not to mention other interpreters or bytecode systems like Perl.  Do we need another one?</p>
</div>
<div class="paragraph">
<p>Well, maybe not, but Glulx is simple enough that it was easier to design and implement it than to use something else.
Really.</p>
</div>
<div class="paragraph">
<p>The Inform compiler already does most of the work of translating a high-level language to bytecode.
It has long since outgrown many of the IF-specific features of the Z-machine (such as the object structure.)
So it makes sense to remove those features, leaving a generic VM.
Furthermore, there are enough other constraints (Inform&#8217;s assumption of a flat memory model, the desire to have a lightweight VM suitable for PDAs) that no existing system is really ideal.
So it seems worthwhile to design a new one.</p>
</div>
<div class="paragraph">
<p>Indeed, most of the effort that has gone into this system has been modifying Inform.
Glulx itself is nearly an afterthought.</p>
</div>
</div>
<div class="sect2">
<h3 id="_glulx_and_other_if_systems"><a class="anchor" href="#_glulx_and_other_if_systems"></a>Glulx and Other IF Systems</h3>
<div class="paragraph">
<p>Glulx grew out of the desire to extend Inform.
However, it may well be suitable as a VM for other IF systems.</p>
</div>
<div class="paragraph">
<p>Or maybe not.
Since Glulx <em>is</em> so lightweight, a compiler has to be fairly complex to compile to it.
Many IF systems take the approach of a simple compiler, and a complex, high-level, IF-specific interpreter.
Glulx is not suitable for this.</p>
</div>
<div class="paragraph">
<p>However, if a system wants to use a simple runtime format with 32-bit data, Glulx may be a good choice.</p>
</div>
<div class="paragraph">
<p>Note that this is entirely separate from question of the I/O layer.
Glulx uses the Glk I/O API, for the sake of simplicity and portability.
Any IF system can do the same.
One can use Glk I/O without using the Glulx game-file format.</p>
</div>
<div class="paragraph">
<p>On the obverse, one could also extend the Glulx VM to use a different I/O system instead of Glk.
One such extension is FyreVM, a commercial IF system developed by Textfyre.
FyreVM is described at
<a href="https://web.archive.org/web/20080524015249/https://textfyre.com/fyrevm/" title="View archived version at Wayback Machine" target="_blank" rel="noopener">http://textfyre.com/fyrevm/</a>.</p>
</div>
<div class="paragraph">
<p>Other extension projects, not yet solidified, are being developed by Dannii Willis.
See <a href="https://curiousdannii.github.com/if/" class="bare" target="_blank" rel="noopener">https://curiousdannii.github.com/if/</a>.</p>
</div>
<div class="paragraph">
<p>This specification does not cover FyreVM and the other projects, except to note opcodes, gestalt selectors, and iosys values that are specific to them.</p>
</div>
</div>
<div class="sect2">
<h3 id="_credits"><a class="anchor" href="#_credits"></a>Credits</h3>
<div class="paragraph">
<p>Graham Nelson gets pretty much all of it.
Without Inform, there would be no reason for any of this.
The entirety of Glulx is fallout from my attempt to deconstruct Inform and rebuild its code generator in my own image, with Graham&#8217;s support.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_machine"><a class="anchor" href="#_the_machine"></a>1. The Machine</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Glulx machine consists of main memory, the stack, and a few registers (the program counter, the stack pointer, and the call-frame pointer.)</p>
</div>
<div class="paragraph">
<p>Main memory is a simple array of bytes, numbered from zero up.
When accessing multibyte values, the most significant byte is stored first (big-endian).
Multibyte values are not necessarily aligned in memory.</p>
</div>
<div class="paragraph">
<p>The stack is an array of values.
It is not a part of main memory; the terp maintains it separately.
The format of the stack is technically up to the implementation.
However, the needs of the machine (especially the game-save format) leave about one good option.
(See <a href="#_the_save_game_format">section 1.8, &#8220;The Save-Game Format&#8221;</a>.)
One important point: the stack can be kept in either byte ordering.
The program should make no assumptions about endianness on the stack.
(In fact, programs should never need to care.)
Values on the stack always have their natural alignment (16-bit values at even addresses, 32-bit values at multiples of four).</p>
</div>
<div class="paragraph">
<p>The stack consists of a set of call frames, one for each function in the current chain.
When a function is called, a new stack frame is pushed, containing the function&#8217;s local variables.
The function can then push or pull 32-bit values on top of that, to store intermediate computations.</p>
</div>
<div class="paragraph">
<p>All values are treated as unsigned integers, unless otherwise noted.
Signed integers are handled with the usual two&#8217;s-complement notation.
Arithmetic overflows and underflows are truncated, also as usual.</p>
</div>
<div class="sect2">
<h3 id="_input_and_output"><a class="anchor" href="#_input_and_output"></a>1.1. Input and Output</h3>
<div class="paragraph">
<p>No input/output facilities are built into the Glulx machine itself.
Instead, the machine has one or more opcodes which dispatch calls to an I/O library.</p>
</div>
<div class="paragraph">
<p>At the moment, that means Glk.
All Glulx interpreters support the Glk I/O facility (via the <code>glk</code> opcode), and no other I/O facilities exist.
However, other I/O libraries may be adapted to Glk in the future.
For best behavior, a program should test for the presence of an I/O facility before using it, using the <code>IOSystem</code> gestalt selector (see <a href="#_miscellaneous">section 2.18, &#8220;Miscellaneous&#8221;</a>).</p>
</div>
<div class="paragraph">
<p>One I/O system is set as current at any given time.
This does not mean that the others are unavailable.
(If the interpreter supports Glk, for example, the <code>glk</code> opcode will always function.)
However, the basic Glulx output opcodes&#8201;&#8212;&#8201;<code>streamchar</code>, <code>streamnum</code>, and <code>streamstr</code>&#8201;&#8212;&#8201;always print using the current I/O system.</p>
</div>
<div class="paragraph">
<p>Every Glulx interpreter supports at least one normal I/O facility (such as Glk), and also two special facilities.</p>
</div>
<div class="paragraph">
<p>The &#8220;null&#8221; I/O system does nothing.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
If this is selected, all Glulx output is simply discarded.
When the Glulx machine starts up, the null system is the current system.
You must select a different one before using the <code>streamchar</code>, <code>streamnum</code>, or <code>streamstr</code> opcodes.</p>
</div>
<div class="paragraph">
<p>The &#8220;filter&#8221; I/O system allows the Glulx program itself to handle output.
The program specifies a function when selecting this I/O system.
That function is then called for every single character of output that the machine generates (via <code>streamchar</code>, <code>streamnum</code>, or <code>streamstr</code>).
The function can output its character directly via the <code>glk</code> opcode (or one of the other output opcodes).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This may all seem rather baroque, but in practice most authors can ignore it.
Most programs will want to test for the Glk facility, set it to be the current output system immediately, and then leave the I/O system alone for the rest of the game.
All output will then automatically be handled through Glk.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_the_memory_map"><a class="anchor" href="#_the_memory_map"></a>1.2. The Memory Map</h3>
<div class="paragraph">
<p>Memory is divided into several segments.
The sizes of the segments are determined by constant values in the game-file header.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>  Segment    Address (hex)

+---------+  00000000
| Header  |
| - - - - |  00000024
|         |
|   ROM   |
|         |
+---------+  RAMSTART
|         |
|   RAM   |
|         |
| - - - - |  EXTSTART
|         |
|         |
+---------+  ENDMEM</pre>
</div>
</div>
<div class="paragraph">
<p>As you might expect, the section marked ROM never changes during execution; it is illegal to write there.
Executable code and constant data are usually (but not necessarily) kept in ROM.
Note that unlike the Z-machine, the Glulx machine&#8217;s ROM comes before RAM; the 36-byte header is part of ROM.</p>
</div>
<div class="paragraph">
<p>The boundary marked EXTSTART is a trivial gimmick for making game-files smaller.
A Glulx game-file only stores the data from 0 to EXTSTART.
When the terp loads it in, it allocates memory up to ENDMEM; everything above EXTSTART is initialized to zeroes.
Once execution starts, there is no difference between the memory above and below EXTSTART.</p>
</div>
<div class="paragraph">
<p>For the convenience of paging interpreters, the three boundaries RAMSTART, EXTSTART, and ENDMEM must be aligned on 256-byte boundaries.</p>
</div>
<div class="paragraph">
<p>Any of the segments of memory can be zero-length, except that ROM must be at least 256 bytes long (so that the header fits in it).</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_stack"><a class="anchor" href="#_the_stack"></a>1.3. The Stack</h3>
<div class="paragraph">
<p>The stack pointer starts at zero, and the stack grows upward.
The maximum size of the stack is determined by a constant value in the game-file header.
For convenience, this must be a multiple of 256.</p>
</div>
<div class="paragraph">
<p>The stack pointer counts in bytes.
If you push a 32-bit value on the stack, the pointer increases by four.</p>
</div>
<div class="sect3">
<h4 id="_the_call_frame"><a class="anchor" href="#_the_call_frame"></a>1.3.1. The Call Frame</h4>
<div class="paragraph">
<p>A call frame looks like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>+------------+  FramePtr
| Frame Len  |    (4 bytes)
| Locals Pos |    (4 bytes)
|            |
| Format of  |    (2*n bytes)
|     Locals |
|            |
| Padding    |    (0 or 2 bytes)
+------------+  FramePtr+LocalsPos
| Locals     |    (1, 2, or 4 bytes each)
|            |
| Padding    |    (0 to 3 bytes)
+------------+  FramePtr+FrameLen
| Values     |    (4 bytes each)
|      ....  |
+------------+  StackPtr</pre>
</div>
</div>
<div class="paragraph">
<p>When a function begins executing, the last segment is empty (StackPtr equals FramePtr+FrameLen.)
Computation can push and pull 32-bit values on the stack.
It is illegal to pop back beyond the original FramePtr+FrameLen boundary.</p>
</div>
<div class="paragraph">
<p>The &#8220;locals&#8221; are a list of values which the function uses as local variables.
These also include function arguments.
(The first N locals can be used as the arguments to an N-argument function.)
Locals can be 8, 16, or 32-bit values.
They are not necessarily contiguous; padding is inserted wherever necessary to bring a value to its natural alignment (16-bit values at even addresses, 32-bit values at multiples of four).</p>
</div>
<div class="paragraph">
<p>The &#8220;format of locals&#8221; is a series of bytes, describing the arrangement of the &#8220;locals&#8221; section of the frame (from LocalsPos up to FrameLen).
This information is copied directly from the header of the function being called.
(See <a href="#_functions">section 1.6.2, &#8220;Functions&#8221;</a>.)</p>
</div>
<div class="paragraph">
<p>Each field in this section is two bytes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>LocalType: 1, 2, or 4, indicating a set of locals which are that many bytes each.</p>
</li>
<li>
<p>LocalCount: 1 to 255, indicating how many locals of LocalType to declare.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The section is terminated by a pair of zero bytes.
Another pair of zeroes is added if necessary to reach a four-byte boundary.</p>
</div>
<div class="paragraph">
<p>(Example: if a function has three 8-bit locals followed by six 16-bit locals, the format segment would contain eight bytes: (1, 3, 2, 6, 0, 0, 0, 0).
The locals segment would then be 16 bytes long, with a padding byte after the third local.)</p>
</div>
<div class="paragraph">
<p>The &#8220;format of locals&#8221; information is needed by the terp in two places: when calling a function (to write in function arguments), and when saving the game (to fix byte-ordering of the locals.)
The formatting is <em>not</em> enforced by the terp while a function is executing.
The program is not prevented from accessing locations whose size and position don&#8217;t match the formatting, or locations that overlap, or even locations in the padding between locals.
However, if a program does this, the results are undefined, because the byte-ordering of locals is up to the terp.
The save-game algorithm will fail, if nothing else.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In fact, the call frame may not exist as a byte sequence during function execution.
The terp is free to maintain a more structured form, as long as it generates valid save-game files, and correctly handles accesses to valid (according to the format) locals.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>8-bit and 16-bit locals have never been in common use, and this spec has not been unambiguous in describing their handling.
(By which I mean, what I implemented in the reference interpreter didn&#8217;t match the spec.)
Therefore, 8-bit and 16-bit locals are deprecated.
Use of the <code>copyb</code> and <code>copys</code> opcodes with a local-variable operand is also deprecated.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_call_stubs"><a class="anchor" href="#_call_stubs"></a>1.3.2. Call Stubs</h4>
<div class="paragraph">
<p>Several different Glulx operations require the ability to jump back to a previously-saved execution state.
(For example: function call/return, game-state save/restore, and exception catch/throw.)</p>
</div>
<div class="paragraph">
<p>For simplicity, all these operations store the execution state the same way&#8201;&#8212;&#8201;as a &#8220;call stub&#8221; on the stack.
This is a block of four 32-bit values.
It encodes the PC and FramePtr, and also a location to store a single 32-bit value at jump-back time.
(For example, the function return value, or the game-restore success flag.)</p>
</div>
<div class="paragraph">
<p>The values are pushed on the stack in the following order (FramePtr pushed last):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>+-----------+
| DestType  |  (4 bytes)
| DestAddr  |  (4 bytes)
| PC        |  (4 bytes)
| FramePtr  |  (4 bytes)
+-----------+</pre>
</div>
</div>
<div class="paragraph">
<p>FramePtr is the current value of FramePtr&#8201;&#8212;&#8201;the stack position of the call frame of the function during which the call stub was generated.</p>
</div>
<div class="paragraph">
<p>PC is the current value of the program counter.
This is the address of the instruction <em>after</em> the one which caused the call stub to be generated.
(For example, for a function call, the call stub contains the address of the first instruction to execute after the function returns.)</p>
</div>
<div class="paragraph">
<p>DestType and DestAddr describe a location in which to store a result.
This will occur after the operation is completed (function returned, game restored, etc).
It happens after the PC and FramePtr are reloaded from the call stub, and the call stub is removed from the stack.</p>
</div>
<div class="paragraph">
<p>DestType is one of the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0: Do not store.
The result value is discarded.
DestAddr should be zero.</p>
</li>
<li>
<p>1: Store in main memory.
The result value is stored in the main-memory address given by DestAddr.</p>
</li>
<li>
<p>2: Store in local variable.
The result value is stored in the call frame at position ((FramePtr+LocalsPos) + DestAddr).
See <a href="#_instruction_format">section 1.5, &#8220;Instruction Format&#8221;</a>.</p>
</li>
<li>
<p>3: Push on stack.
The result value is pushed on the stack.
DestAddr should be zero.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The string-decoding mechanism complicates matters a little, since it is possible for a function to be called from inside a string, instead of another function.
(See <a href="#_calling_and_returning_within_strings">section 1.3.4, &#8220;Calling and Returning Within Strings&#8221;</a>.)
The following DestType values allow this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>10: Resume printing a compressed (E1) string.
The PC value contains the address of the byte (within the string) to continue printing in.
The DestAddr value contains the bit number (0 to 7) within that byte.</p>
</li>
<li>
<p>11: Resume executing function code after a string completes.
The PC value contains the program counter as usual, but the FramePtr field is ignored, since the string is printed in the same call frame as the function that executed it.
DestAddr should be zero.</p>
</li>
<li>
<p>12: Resume printing a signed decimal integer.
The PC value contains the integer itself.
The DestAddr value contains the position of the digit to print next.
(0 indicates the first digit, or the minus sign for negative integers; and so on.)</p>
</li>
<li>
<p>13: Resume printing a C-style (E0) string.
The PC value contains the address of the character to print next.
The DestAddr value should be zero.</p>
</li>
<li>
<p>14: Resume printing a Unicode (E2) string.
The PC value contains the address of the (four-byte) character to print next.
The DestAddr value should be zero.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_calling_and_returning"><a class="anchor" href="#_calling_and_returning"></a>1.3.3. Calling and Returning</h4>
<div class="paragraph">
<p>When a function is called, the terp pushes a four-value call stub.
(This includes the return-value destination, the PC, and the FramePtr; see <a href="#_call_stubs">section 1.3.2, &#8220;Call Stubs&#8221;</a>.)
The terp then sets the FramePtr to the StackPtr, and builds a new call frame.
(See <a href="#_the_call_frame">section 1.3.1, &#8220;The Call Frame&#8221;</a>.)
The PC moves to the first instruction of the function, and execution continues.</p>
</div>
<div class="paragraph">
<p>Function arguments can be stored in the locals of the new call frame, or pushed on the stack above the new call frame.
This is determined by the type of the function; see <a href="#_functions">section 1.6.2, &#8220;Functions&#8221;</a>.</p>
</div>
<div class="paragraph">
<p>When a function returns, the process is reversed.
First  is set back to FramePtr, throwing away the current call frame (and any pushed values).
The FramePtr and PC are popped off the stack, and then the return-value destination.
The function&#8217;s return value is stored where the destination says it should be.
Then execution continues at the restored PC.</p>
</div>
<div class="paragraph">
<p>(But note that a function can also return to a suspended string, as well as a suspended caller function.
See <a href="#_calling_and_returning_within_strings">section 1.3.4, &#8220;Calling and Returning Within Strings&#8221;</a> and <a href="#_calling_and_returning_during_output_filtering">section 1.3.5, &#8220;Calling and Returning During Output Filtering&#8221;</a>.)</p>
</div>
</div>
<div class="sect3">
<h4 id="_calling_and_returning_within_strings"><a class="anchor" href="#_calling_and_returning_within_strings"></a>1.3.4. Calling and Returning Within Strings</h4>
<div class="paragraph">
<p>Glulx uses a Huffman string-compression scheme.
This allows bit sequences in strings to decode to large strings, or even function invocations which generate output.
This means the <code>streamstr</code> opcode can invoke function calls, and we must therefore be able to represent this situation on the stack.</p>
</div>
<div class="paragraph">
<p>When the terp begins printing a string, it pushes a type-11 call stub.
(This includes only the current PC.
The FramePtr is included, for consistency&#8217;s sake, but it will be ignored when the call stub is read back off.)
The terp then starts decoding the string data.
The PC now indicates the position within the string data.</p>
</div>
<div class="paragraph">
<p>If, during string decoding, the terp encounters an indirect reference to a string or function, it pushes a type-10 call stub.
This includes the string-decoding PC, and the bit number within that address.
It also includes the current FramePtr, which has not changed since string-printing began.</p>
</div>
<div class="paragraph">
<p>If the indirect reference is to another string, the decoding continues at the new location after the type-10 stub is pushed.
However, if the reference is to a function, the usual call frame is pushed on top of the type-10 stub, and the terp returns to normal function execution.</p>
</div>
<div class="paragraph">
<p>When a string completes printing, the terp pops a call stub.
This will necessarily be either a type-10 or type-11.
If the former, the terp resumes string decoding at the PC address/bit number in the stub.
If the latter, the topmost string is finished, and the terp resumes function execution at the stub&#8217;s PC.</p>
</div>
<div class="paragraph">
<p>When a function returns, it must check to see if it was called from within a string, instead of from another function.
This is the case if the call stub it pops is type-10.
(The call stub cannot be type-11.)
If so, the FramePtr is taken from the stub as usual; but the stub&#8217;s PC is taken to refer to a string data address, with the DestAddr value being the bit number within that address.
(The function&#8217;s return value is discarded.)
String decoding resumes from there.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It may seem wasteful for the terp to push and pop a call stub every time a string is printed.
Fortunately, in the most common case&#8201;&#8212;&#8201;printing a string with no indirect references at all&#8201;&#8212;&#8201;this can easily be optimized out.
(No VM code is executed between the push and pop, so it is safe to skip them.)
Similarly, when printing an unencoded (E0) string, there can be no indirect references, so it is safe to optimize away the call stub push/pop.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_calling_and_returning_during_output_filtering"><a class="anchor" href="#_calling_and_returning_during_output_filtering"></a>1.3.5. Calling and Returning During Output Filtering</h4>
<div class="paragraph">
<p>The &#8220;filter&#8221; I/O system allows the terp to call a Glulx function for each character that is printed via <code>streamchar</code>, <code>streamnum</code>, or <code>streamstr</code>.
We must be able to represent this situation on the call stack as well.</p>
</div>
<div class="paragraph">
<p>If filtering is the current I/O system, then when the terp executes <code>streamchar</code>, it pushes a normal function call stub and begins executing the output function.
Nothing else is required; when the function returns, execution will resume after the <code>streamchar</code> opcode.
(A type-0 call stub is used, so the function&#8217;s return value is discarded.)</p>
</div>
<div class="paragraph">
<p>The other output opcodes are more complex.
When the terp executes <code>streamnum</code>, it pushes a type-11 call stub.
As before, this records the current PC.
The terp then pushes a type-12 call stub, which contains the integer being printed and the position of the next character to be printed (namely 1).
It then executes the output function.</p>
</div>
<div class="paragraph">
<p>When the output function returns, the terp pops the type-12 stub and realizes that it should continue printing the integer contained therein.
It pushes another type-12 stub back on the stack, indicating that the next position to print is 2, and calls the output function again.</p>
</div>
<div class="paragraph">
<p>This process continues until there are no more characters in the decimal representation of the integer.
The terp then pops the type-11 stub, restores the PC, and resumes execution after the <code>streamnum</code> opcode.</p>
</div>
<div class="paragraph">
<p>The <code>streamstr</code> opcode works on the same principle, except that instead of type-12 stubs, the terp uses type-10 stubs (when interrupting an encoded string) and type-13/14 stubs (when interruping a C-style, null-terminated string of bytes/Unicode chars).
Type-13 and type-14 stubs look like the others, except that they contain only the address of the next character to print; no other position or bit number is necessary.</p>
</div>
<div class="paragraph">
<p>The interaction between the filter I/O system and indirect string/function calls within encoded strings is left to the reader&#8217;s imagination.<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_header"><a class="anchor" href="#_the_header"></a>1.4. The Header</h3>
<div class="paragraph">
<p>The header is the first 36 bytes of memory.
It is always in ROM, so its contents cannot change during execution.
The header is organized as nine 32-bit values.
(Recall that values in memory are always big-endian.)</p>
</div>
<div class="literalblock">
<div class="content">
<pre>+---------------+  address 0
| Magic Number  |  (4 bytes)
| Glulx Version |  (4 bytes)
| RAMSTART      |  (4 bytes)
| EXTSTART      |  (4 bytes)
| ENDMEM        |  (4 bytes)
| Stack Size    |  (4 bytes)
| Start Func    |  (4 bytes)
| Decoding Tbl  |  (4 bytes)
| Checksum      |  (4 bytes)
+---------------+</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Magic number: 47 6C 75 6C, which is to say ASCII &#8216;Glul&#8217;.</p>
</li>
<li>
<p>Glulx version number: The upper 16 bits stores the major version number; the next 8 bits stores the minor version number; the low 8 bits stores an even more minor version number, if any.
This specification is version 3.1.2, so a game file generated to this spec would contain 0x00030102.</p>
</li>
<li>
<p>RAMSTART: The first address which the program can write to.</p>
</li>
<li>
<p>EXTSTART: The end of the game-file&#8217;s stored initial memory (and therefore the length of the game file.)</p>
</li>
<li>
<p>ENDMEM: The end of the program&#8217;s memory map.</p>
</li>
<li>
<p>Stack size: The size of the stack needed by the program.</p>
</li>
<li>
<p>Address of function to execute: Execution commences by calling this function.</p>
</li>
<li>
<p>Address of string-decoding table: This table is used to decode compressed strings.
See <a href="#_compressed_strings">section 1.6.1.3, &#8220;Compressed strings&#8221;</a>.
This may be zero, indicating that no compressed strings are to be decoded.<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup></p>
</li>
<li>
<p>Checksum: A simple sum of the entire initial contents of memory, considered as an array of big-endian 32-bit integers.
The checksum should be computed with this field set to zero.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The interpreter should validate the magic number and the Glulx version number.
An interpreter which is written to version X.Y.Z of this specification should accept game files whose Glulx version between X.0.0 and X.Y.*.
(That is, the major version number should match; the minor version number should be less than or equal to Y; the subminor version number does not matter.)</p>
</div>
<div class="paragraph">
<p>EXCEPTION: A version 3.* interpreter should accept version 2.0 game files.
The only difference between spec 2.0 and spec 3.0 is that 2.0 lacks Unicode functionality.
Therefore, an interpreter written to this version of the spec (3.1.2) should accept game files whose version is between 2.0.0 and 3.1.* (0x00020000 and 0x000301FF inclusive).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These rules mean, in the vernacular, that minor version changes are backwards compatible, and subminor version changes are backwards and forwards compatible.
If I add a feature which I expect every terp to implement (e.g. <code>mzero</code> and <code>mcopy</code>), then I bump the minor version number, and your game can use that feature without worrying about availability.
If I add a feature which not all terps will implement (e.g. floating point), then I bump the subminor version number, and your game should only use the feature after doing a <code>gestalt</code> test for availability.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The header is conventionally followed by a 32-bit word which describes the layout of data in the rest of the file.
This value is <em>not</em> a part of the Glulx specification; it is the first ROM word after the header, not a part of the header.
It is an option that compilers can insert, when generating Glulx files, to aid debuggers and decompilers.</p>
</div>
<div class="paragraph">
<p>For Inform-generated Glulx files, this descriptive value is 49 6E 66 6F, which is to say ASCII &#8216;Info&#8217;.
There then follow several more bytes of data relevant to the Inform compiler.
See the Glulx chapter of the Inform Technical Manual.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Note that version 2.0 (pre-Unicode) has been obsolete since 2006.
There are still 2.0 game files out there, so interpreters should still support them.
However, there are no 2.0-only interpreters left; so compilers may freely target 3.*.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_instruction_format"><a class="anchor" href="#_instruction_format"></a>1.5. Instruction Format</h3>
<div class="paragraph">
<p>There are 2^28 Glulx opcodes, numbered from 0 to 0FFFFFFF.
If this proves insufficient, more may be added in the future.</p>
</div>
<div class="paragraph">
<p>An instruction is encoded as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>+--------------+
| Opcode Num   |  (1 to 4 bytes)
|              |
| Operand      |  (two per byte)
|   Addr Modes |
|              |
| Operand Data |  (as defined by
|        ....  |      addr modes)
+--------------+</pre>
</div>
</div>
<div class="paragraph">
<p>The opcode number OP, which can be anything up to 0FFFFFFF, may be packed into fewer than four bytes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>00..7F: One byte, OP</p>
</li>
<li>
<p>0000..3FFF: Two bytes, OP+8000</p>
</li>
<li>
<p>00000000..0FFFFFFF: Four bytes, OP+C0000000</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that the length of this field can be decoded by looking at the top two bits of the first byte.
Also note that, for example, 01 and 8001 and C0000001 all represent the same opcode.</p>
</div>
<div class="paragraph">
<p>The operand addressing modes are a list of fields which tell where opcode arguments are read from or written to.
Each is four bits long, and they are packed two to a byte.
(They occur in the same order as the arguments, low bits first.
If there are an odd number, the high bits of the last byte are left zero.)</p>
</div>
<div class="paragraph">
<p>Since each addressing mode is a four-bit number, there are sixteen addressing modes.
Each is associated with a fixed number of bytes in the &#8220;operand data&#8221; segment of the instruction.
These bytes appear after the addressing modes, in the same order.
(There is no alignment padding.)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0: Constant zero. (Zero bytes)</p>
</li>
<li>
<p>1: Constant, -80 to 7F. (One byte)</p>
</li>
<li>
<p>2: Constant, -8000 to 7FFF. (Two bytes)</p>
</li>
<li>
<p>3: Constant, any value. (Four bytes)</p>
</li>
<li>
<p>4: (Unused)</p>
</li>
<li>
<p>5: Contents of address 00 to FF. (One byte)</p>
</li>
<li>
<p>6: Contents of address 0000 to FFFF. (Two bytes)</p>
</li>
<li>
<p>7: Contents of any address. (Four bytes)</p>
</li>
<li>
<p>8: Value popped off stack. (Zero bytes)</p>
</li>
<li>
<p>9: Call frame local at address 00 to FF. (One byte)</p>
</li>
<li>
<p>A: Call frame local at address 0000 to FFFF. (Two bytes)</p>
</li>
<li>
<p>B: Call frame local at any address. (Four bytes)</p>
</li>
<li>
<p>C: (Unused)</p>
</li>
<li>
<p>D: Contents of RAM address 00 to FF. (One byte)</p>
</li>
<li>
<p>E: Contents of RAM address 0000 to FFFF. (Two bytes)</p>
</li>
<li>
<p>F: Contents of RAM, any address. (Four bytes)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Things to note:</p>
</div>
<div class="paragraph">
<p>The &#8220;constant&#8221; modes sign-extend their data into a 32-bit value; the other modes do not.
This is just because negative constants occur more frequently than negative addresses.</p>
</div>
<div class="paragraph">
<p>The indirect modes (all except &#8220;constant&#8221;) access 32-bit fields, either in the stack or in memory.
This means four bytes starting at the given address.
A few opcodes are exceptions: <code>copyb</code> and <code>copys</code> (copy byte and copy short) access 8-bit and 16-bit fields (one or two bytes starting at the given address.)</p>
</div>
<div class="paragraph">
<p>The &#8220;call frame local&#8221; modes access a field on the stack, starting at byte ((FramePtr+LocalsPos) + address).
As described in <a href="#_the_call_frame">section 1.3.1, &#8220;The Call Frame&#8221;</a>, this must be aligned with (and the same size as) one of the fields described in the function&#8217;s locals format.
It must not point outside the range of the current function&#8217;s locals segment.</p>
</div>
<div class="paragraph">
<p>The &#8220;contents of address&#8221; modes access a field in main memory, starting at byte (addr).
The &#8220;contents of RAM&#8221; modes access a field in main memory, starting at byte (RAMSTART + addr).
Since the byte-ordering of main memory is well-defined, these need not have any particular alignment or position.</p>
</div>
<div class="paragraph">
<p>All address addition is truncated to 32 bits, and addresses are unsigned.
So, for example, &#8220;contents of RAM&#8221; address FFFFFFFC (RAMSTART + FFFFFFFC) accesses the last 32-bit value in ROM, since it effectively subtracts 4 from RAMSTART. &#8220;Contents of address&#8221; FFFFFFFC would access the very last 32-bit value in main memory, assuming you can find a terp which handles four-gigabyte games. &#8220;Call frame local&#8221; FFFFFFFC is illegal; whether you interpret it as a negative number or a large positive number, it&#8217;s outside the current call frame&#8217;s locals segment.</p>
</div>
<div class="paragraph">
<p>Some opcodes store values as well as reading them in.
Store operands use the same addressing modes, with a few exceptions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>8: The value is pushed into the stack, instead of being popped off.</p>
</li>
<li>
<p>3, 2, 1: These modes cannot be used, since it makes no sense to store
to a constant.<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup></p>
</li>
<li>
<p>0: This mode means &#8220;throw the value away&#8221;; it is not stored at all.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Operands are evaluated from left to right.
(This is important if there are several push/pop operands.)</p>
</div>
</div>
<div class="sect2">
<h3 id="_typable_objects"><a class="anchor" href="#_typable_objects"></a>1.6. Typable Objects</h3>
<div class="paragraph">
<p>It is convenient for a program to store object references as 32-bit pointers, and still determine the type of a reference at run-time.</p>
</div>
<div class="paragraph">
<p>To facilitate this, structured objects in Glulx main memory follow a simple convention: the first byte indicates the type of the object.</p>
</div>
<div class="paragraph">
<p>At the moment, there are only two kinds of Glulx objects: functions and strings.
A program (or compiler, or library) may declare more, but the Glulx VM does not have to know about them.</p>
</div>
<div class="paragraph">
<p>Of course, not every byte in memory is the start of the legitimate object.
It is the program&#8217;s responsibility to keep track of which values validly refer to typable objects.</p>
</div>
<div class="sect3">
<h4 id="_strings"><a class="anchor" href="#_strings"></a>1.6.1. Strings</h4>
<div class="paragraph">
<p>Strings have a type byte of E0 (for unencoded, C-style strings), E2 (for unencoded strings of Unicode values), or E1 (for compressed strings.)
Types E3 to FF are reserved for future expansion of string types.</p>
</div>
<div class="sect4">
<h5 id="_unencoded_strings"><a class="anchor" href="#_unencoded_strings"></a>1.6.1.1. Unencoded strings</h5>
<div class="paragraph">
<p>An unencoded string consists of an E0 byte, followed by all the bytes of the string, followed by a zero byte.</p>
</div>
</div>
<div class="sect4">
<h5 id="_unencoded_unicode_strings"><a class="anchor" href="#_unencoded_unicode_strings"></a>1.6.1.2. Unencoded Unicode strings</h5>
<div class="paragraph">
<p>An unencoded Unicode string consists of an E2 byte, followed by three padding 0 bytes, followed by the Unicode character values (each one being a four-byte integer).
Finally, there is a terminating value (four 0 bytes).</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Unencoded Unicode string
+----------------+
| Type: E2       |  (1 byte)
| Padding: 00    |  (3 bytes)
| Characters.... |  (any length, multiple of 4)
| NUL: 00000000  |  (4 bytes)
+----------------+</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the character data is not encoded in UTF-8, UTF-16, or any other peculiar encoding.
It is treated as an array of 32-bit integers (which are, as always in Glulx, stored big-endian).
Each integer is a Unicode code point.</p>
</div>
</div>
<div class="sect4">
<h5 id="_compressed_strings"><a class="anchor" href="#_compressed_strings"></a>1.6.1.3. Compressed strings</h5>
<div class="paragraph">
<p>A compressed string consists of an E1 byte, followed by a block of Huffman-encoded data.
This should be read as a stream of bits, starting with the low bit (the 1 bit) of the first byte after the E1, proceeding through the high bit (the 128 bit), and so on with succeeding bytes.</p>
</div>
<div class="paragraph">
<p>Decoding compressed strings requires looking up data in a Huffman table.
The address of this table is normally found in the header.
However, the program can select a different decompression table at run-time; see <a href="#Output">section 2.11, &#8220;Output&#8221;</a>.</p>
</div>
<div class="paragraph">
<p>The Huffman table is logically a binary tree.
Internal nodes are branch points; leaf nodes represent printable entities.
To decode a string, begin at the root node.
Read one bit from the bit stream, and go to the left or right child depending on its value.
Continue reading bits and branching left or right, until you reach a leaf node.
Print that entity.
Then jump back to the root, and repeat the process.
One particular leaf node indicates the end of the string (rather than any printable entity), and when the bit stream leads you to that node, you stop.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is a fairly slow process, with VM memory reads and a conditional test for every <em>bit</em> of the string.
A terp can speed it up considerably by reading the Huffman table all at once, and caching it as native data structures.
A binary tree is the obvious choice, but one can do even better (at the cost of some space) by looking up four-bit chunks at a time in a 16-branching tree.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Note that decompression tables are not necessarily in ROM.
This is particularly important for tables that are generated and selected at run-time.
Furthermore, it is technically legal for a table in RAM to be altered at runtime&#8201;&#8212;&#8201;possibly even when it is the currently-selected table.
Therefore, an interpreter that caches or preloads this decompression data must be careful.
If it caches data from RAM, it must watch for writes to that RAM space, and invalidate its cache upon seeing such a write.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_the_string_decoding_table"><a class="anchor" href="#_the_string_decoding_table"></a>1.6.1.4. The String-Decoding Table</h5>
<div class="paragraph">
<p>The decoding table has the following format:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>+-----------------+
| Table Length    |  (4 bytes)
| Number of Nodes |  (4 bytes)
| Root Node Addr  |  (4 bytes)
| Node Data ....  |  (table length - 12 bytes)
+-----------------+</pre>
</div>
</div>
<div class="paragraph">
<p>The table length is measured in bytes, from the beginning of the table to the end of the last node.
The node count includes both branch and leaf nodes.<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup></p>
</div>
<div class="paragraph">
<p>The root address indicates which node is the root of the tree; it is not necessarily the first node.
This is an absolute address, not an offset from the beginning of the table.</p>
</div>
<div class="paragraph">
<p>There then follow all the nodes, with no extra data before, between, or after them.
They need not be in any particular order.
There are several possible types of nodes, distinguished by their first byte.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Branch (non-leaf node)
+----------------+
| Type: 00       |  (1 byte)
| Left  (0) Node |  (4 bytes)
| Right (1) Node |  (4 bytes)
+----------------+</pre>
</div>
</div>
<div class="paragraph">
<p>The left and right node fields are addresses (again, absolute addresses) of the nodes to go to given a 0 or 1 bit from the bit stream.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>String terminator
+----------------+
| Type: 01       |  (1 byte)
+----------------+</pre>
</div>
</div>
<div class="paragraph">
<p>This ends the string-decoding process.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Single character
+----------------+
| Type: 02       |  (1 byte)
| Character      |  (1 byte)
+----------------+</pre>
</div>
</div>
<div class="paragraph">
<p>This prints a single character.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The encoding scheme is the business of the I/O system; in Glk, it will be the Latin-1 character set.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="content">
<pre>C-style string
+----------------+
| Type: 03       |  (1 byte)
| Characters.... |  (any length)
| NUL: 00        |  (1 byte)
+----------------+</pre>
</div>
</div>
<div class="paragraph">
<p>This prints an array of characters.
Note that the array cannot contain a zero byte, since that is reserved to terminate the array.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A zero byte can be printed using the single-character node type.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="content">
<pre>Single Unicode character
+----------------+
| Type: 04       |  (1 byte)
| Character      |  (4 bytes)
+----------------+</pre>
</div>
</div>
<div class="paragraph">
<p>This prints a single Unicode character.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To be precise, it prints a 32-bit character, which will be interpreted as Unicode if the I/O system is Glk.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="content">
<pre>C-style Unicode string
+----------------+
| Type: 05       |  (1 byte)
| Characters.... |  (any length, multiple of 4)
| NUL: 00000000  |  (4 bytes)
+----------------+</pre>
</div>
</div>
<div class="paragraph">
<p>This prints an array of Unicode characters.
Note that the array cannot contain a zero word, since that is reserved to terminate the array.
Also note that, unlike an E2-encoded string object, there is no padding.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the Glk library is unable to handle Unicode, node types 04 and 05 are still legal.
However, characters beyond FF will be printed as 3F (&#8220;?&#8221;).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="content">
<pre>Indirect reference
+----------------+
| Type: 08       |  (1 byte)
| Address        |  (4 bytes)
+----------------+</pre>
</div>
</div>
<div class="paragraph">
<p>This prints a string or calls a function, which is not actually part of the decoding table.
The address may refer to a location anywhere in memory (including RAM.)
It must be a valid Glulx string (see <a href="#_strings">section 1.6.1, &#8220;Strings&#8221;</a>) or function (see <a href="#_functions">section 1.6.2, &#8220;Functions&#8221;</a>).
If it is a string, it is printed.
If a function, it is called (with no arguments) and the result is discarded.</p>
</div>
<div class="paragraph">
<p>The management of the stack during an indirect string/function call is a bit tricky.
See <a href="#_calling_and_returning_within_strings">section 1.3.4, &#8220;Calling and Returning Within Strings&#8221;</a>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Double-indirect reference
+----------------+
| Type: 09       |  (1 byte)
| Address        |  (4 bytes)
+----------------+</pre>
</div>
</div>
<div class="paragraph">
<p>This is similar to the indirect-reference node, but the address refers to a four-byte field in memory, and <em>that</em> contains the address of a string or function.
The extra layer of indirection can be useful.
For example, if the four-byte field is in RAM, its contents can be changed during execution, pointing to a new typable object, without modifying the decoding table itself.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Indirect reference with arguments
+----------------+
| Type: 0A       |  (1 byte)
| Address        |  (4 bytes)
| Argument Count |  (4 bytes)
| Arguments....  |  (4*N bytes)
+----------------+

Double-indirect reference with arguments
+----------------+
| Type: 0B       |  (1 byte)
| Address        |  (4 bytes)
| Argument Count |  (4 bytes)
| Arguments....  |  (4*N bytes)
+----------------+</pre>
</div>
</div>
<div class="paragraph">
<p>These work the same as the indirect and double-indirect nodes, but if the object found is a function, it will be called with the given argument list.
If the object is a string, the arguments are ignored.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_functions"><a class="anchor" href="#_functions"></a>1.6.2. Functions</h4>
<div class="paragraph">
<p>Functions have a type byte of C0 (for stack-argument functions) or C1 (for local-argument functions).
Types C2 to DF are reserved for future expansion of function types.</p>
</div>
<div class="paragraph">
<p>A Glulx function always takes a list of 32-bit arguments, and returns exactly one 32-bit value.
(If you want a function which returns no value, discard or ignore it.
Store operand mode zero is convenient.)</p>
</div>
<div class="paragraph">
<p>If the type is C0, the arguments are passed on the stack, and are made available on the stack.
After the function&#8217;s call frame is constructed, all the argument values are pushed&#8201;&#8212;&#8201;last argument pushed first, first argument topmost.
Then the number of arguments is pushed on top of that.
All locals in the call frame itself are initialized to zero.</p>
</div>
<div class="paragraph">
<p>If the type is C1, the arguments are passed on the stack, and are written into the locals according to the &#8220;format of locals&#8221; list of the function.
Arguments passed into 8-bit or 16-bit locals are truncated.
It is legitimate for there to be too many or too few arguments.
Extras are discarded silently; any locals left unfilled are initialized to zero.</p>
</div>
<div class="paragraph">
<p>A function has the following structure:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>+------------+
|  C0 or C1  |  Type (1 byte)
+------------+
| Format of  |    (2*n bytes)
|     Locals |
+------------+
|  Opcodes   |
|      ....  |
+------------+</pre>
</div>
</div>
<div class="paragraph">
<p>The locals-format list is encoded the same way it is on the stack; see <a href="#_the_call_frame">section 1.3.1, &#8220;The Call Frame&#8221;</a>.
This is a list of LocalType/LocalCount byte pairs, terminated by a zero/zero pair.
(There is, however, no extra padding to reach four-byte alignment.)</p>
</div>
<div class="paragraph">
<p>Note that although a LocalType/LocalCount pair can only describe up to 255 locals, there is no restriction on how many locals the function can have.
It is legitimate to encode several pairs in a row with the same LocalType.</p>
</div>
<div class="paragraph">
<p>Immediately following the two zero bytes, the instructions start.
There is no explicit terminator for the function.</p>
</div>
</div>
<div class="sect3">
<h4 id="_other_glulx_objects"><a class="anchor" href="#_other_glulx_objects"></a>1.6.3. Other Glulx Objects</h4>
<div class="paragraph">
<p>There are no other Glulx objects at this time, but type 80 to BF are reserved for future expansion.
Type 00 is also reserved; it indicates &#8220;no object&#8221;, and should not be used by any typable object.
A null reference&#8217;s type would be considered 00.
(Even though byte 00000000 of main memory is not in fact 00.)</p>
</div>
</div>
<div class="sect3">
<h4 id="_user_defined_objects"><a class="anchor" href="#_user_defined_objects"></a>1.6.4. User-Defined Objects</h4>
<div class="paragraph">
<p>Types 01 to 7F are available for use by the compiler, the library, or the program.
Glulx will not use them.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Inform uses 60 for dictionary words, and 70 for objects and classes.
It reserves types 40 to 7F.
Types 01 to 3F remain available for use by Inform programmers.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_floating_point_numbers"><a class="anchor" href="#_floating_point_numbers"></a>1.7. Floating-Point Numbers</h3>
<div class="paragraph">
<p>Glulx values are 32-bit integers, big-endian when stored in memory.
To handle floating-point math, we must be able to encode float values as 32-bit values.
Unsurprisingly, Glulx uses the big-endian, single-precision IEEE-754 encoding.
(See <a href="https://web.archive.org/web/20100714232105/http://www.psc.edu:80/general/software/packages/ieee/ieee.php" title="View archived version at Wayback Machine" target="_blank" rel="noopener">http://www.psc.edu/general/software/packages/ieee/ieee.php</a>.)
This allows floats to be stored in memory, on the stack, in local variables, and in any other place that a 32-bit value appears.</p>
</div>
<div class="paragraph">
<p>However, float values and integer values are <em>not</em> interchangable.
You cannot pass floats to the normal arithmetic opcodes, or vice versa, and expect to get meaningful answers.
Always pass floats to the float opcodes and integers to the int opcodes, with the appropriate conversion opcodes to convert back and forth.
(See <a href="#_floating_point_math">section 2.12, &#8220;Floating-Point Math&#8221;</a>.)</p>
</div>
<div class="paragraph">
<p>Floats have limited precision; they cannot represent all real values exactly.
They can&#8217;t even represent all integers exactly.
(Integers between -1000000 and 1000000 (hex) have exact representations.
Beyond that, the rounding error can be greater than 1.
But when you get into fractions, errors are possible anywhere: 1/3 cannot be stored exactly.)</p>
</div>
<div class="paragraph">
<p>Therefore, you must be careful when comparing results.
A series of float operations may produce a result fractionally different from what you expect.
When comparing float values, you will most often want to use the <code>jfeq</code> opcode, which tests whether two values are <em>near</em> each other (within a specified range).</p>
</div>
<div class="paragraph">
<p>A float value has three fields in its 32 bits, from highest (the sign bit) to lowest:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>+---------------+
| Sign Bit (S)  |  (1 bit)
| Exponent (E)  |  (8 bits)
| Mantissa (M)  |  (23 bits)
+---------------+</pre>
</div>
</div>
<div class="paragraph">
<p>The interpretation of the value depends on the exponent value:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If E is FF and M is zero, the value is positive or negative infinity,
depending on S.
Infinite values represent overflows.
(+Inf is 7F800000; -Inf is FF800000.)</p>
</li>
<li>
<p>If E is FF and M is nonzero, the value is a positive or negative NaN
(&#8220;not a number&#8221;), depending on S.
NaN values represent arithmetic failures.
(+NaN values are in the range 7F800001 to 7FFFFFFF; -NaN are FF800001 to
FFFFFFFF.)</p>
</li>
<li>
<p>If E is 00 and M is zero, the value is a positive or negative zero,
depending on S.
Zero values represent underflows, and also, you know, zero.
(+0 is 00000000; -0 is 80000000.)</p>
</li>
<li>
<p>If E is 00 and M is nonzero, the value is a &#8220;denormalized&#8221; number,
very close to zero: plus or minus 2^(-149)*M.</p>
</li>
<li>
<p>If E is anything else, the value is a &#8220;normalized&#8221; number: plus or
minus 2^(E-150)*(800000+M).</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>I&#8217;m using decimal exponents there amid all the hex constants. -149 is hex -95; -150 is hex -96.
Sorry about that.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The numeric formulas may look more familiar if you write them as 2^(-126)*(0.MMMM&#8230;&#8203;) and 2^(E-127)*(1.MMMM&#8230;&#8203;), where &#8220;0.MMMM&#8230;&#8203;&#8221; is a fraction between zero and one (23 mantissa bits after the binal point) and &#8220;1.MMMM&#8230;&#8203;.&#8221; is a fraction beween one and two.</p>
</div>
<div class="paragraph">
<p>Some example values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0.0   =  00000000 (S=0, E=00, M=0)</p>
</li>
<li>
<p>1.0   =  3F800000 (S=0, E=7F, M=0)</p>
</li>
<li>
<p>-2.0  =  C0000000 (S=1, E=80, M=0)</p>
</li>
<li>
<p>100.0 =  42C80000 (S=0, E=85, M=480000)</p>
</li>
<li>
<p>pi    =  40490FDB (S=0, E=80, M=490FDB)</p>
</li>
<li>
<p>2*pi  =  40C90FDB (S=0, E=81, M=490FDB)</p>
</li>
<li>
<p>e     =  402DF854 (S=0, E=80, M=2DF854)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To give you an idea of the behavior of the special values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1 / 0    =  +Inf</p>
</li>
<li>
<p>-1 / 0   =  -Inf</p>
</li>
<li>
<p>1 / Inf  =  0</p>
</li>
<li>
<p>1 / -Inf =  -0</p>
</li>
<li>
<p>0 / 0    =  NaN</p>
</li>
<li>
<p>2 * 0    =  0</p>
</li>
<li>
<p>2 * -0   =  -0</p>
</li>
<li>
<p>+Inf * 0 =  NaN</p>
</li>
<li>
<p>+Inf * 1 =  +Inf</p>
</li>
<li>
<p>+Inf + +Inf =  +Inf</p>
</li>
<li>
<p>+Inf * +Inf =  +Inf</p>
</li>
<li>
<p>+Inf - +Inf =  NaN</p>
</li>
<li>
<p>+Inf / +Inf =  NaN</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>NaN is sticky; almost <em>any</em> mathematical operation involving a NaN produces NaN.
(There are a few exceptions.)</p>
</div>
<div class="paragraph">
<p>However, Glulx does not guarantee <em>which</em> NaN value you will get from such operations.
The underlying platform may try to encode information about what operation failed in the mantissa field of the NaN.
Or, contrariwise, it may return the same value for every NaN.
The sign bit, similarly, is never guaranteed.
(The sign may be preserved if that&#8217;s meaningful for the failed operation, but it may not be.)
You should not test for NaN by comparing to a fixed encoded value; instead, use the <code>jisnan</code> opcode.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_save_game_format"><a class="anchor" href="#_the_save_game_format"></a>1.8. The Save-Game Format</h3>
<div class="paragraph">
<p>(Or, if you like, &#8220;serializing the machine state&#8221;.)</p>
</div>
<div class="paragraph">
<p>This is a variant of Quetzal, the standard Z-machine save file format.
(See <a href="https://ifarchive.org/if-archive/infocom/interpreters/specification/savefile_14.txt" class="bare" target="_blank" rel="noopener">https://ifarchive.org/if-archive/infocom/interpreters/specification/savefile_14.txt</a>.)</p>
</div>
<div class="paragraph">
<p>Everything in the Quetzal specification applies, with the following exceptions:</p>
</div>
<div class="sect3">
<h4 id="_contents_of_dynamic_memory"><a class="anchor" href="#_contents_of_dynamic_memory"></a>1.8.1. Contents of Dynamic Memory</h4>
<div class="paragraph">
<p>In both compressed and uncompressed form, the memory chunk (&#8216;CMem&#8217; or &#8216;UMem&#8217;) starts with a four-byte value, which is the current size of memory.
The memory data then follows.
During a restore, the size of memory is changed to this position.</p>
</div>
<div class="paragraph">
<p>The memory area to be saved does not start at address zero, but at RAMSTART.
It continues to the current end of memory (which may not be the ENDMEM value in the header.)
When generating or reading compressed data (&#8216;CMem&#8217; chunk), the data above EXTSTART is handled as if the game file were extended with as many zeroes as necessary.</p>
</div>
</div>
<div class="sect3">
<h4 id="_contents_of_the_stack"><a class="anchor" href="#_contents_of_the_stack"></a>1.8.2. Contents of the Stack</h4>
<div class="paragraph">
<p>Before the stack is written out, a four-value call stub is pushed on&#8201;&#8212;&#8201;result destination, PC, and FramePtr.
(See <a href="#_call_stubs">section 1.3.2, &#8220;Call Stubs&#8221;</a>.)
Then the entire stack can be written out, with all of its values (of whatever size) transformed to big-endian.
(Padding is not skipped; it&#8217;s written out as the appropriate number of zero bytes.)</p>
</div>
<div class="paragraph">
<p>When the game-state is loaded back in&#8201;&#8212;&#8201;or, for that matter, when continuing after a game-save&#8201;&#8212;&#8201;the four values are read back off the stack, a result code for the operation is stored in the appropriate destination, and execution continues.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Remember that in a call stub, the PC contains the address of the instruction <em>after</em> the one being executed.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_memory_allocation_heap"><a class="anchor" href="#_memory_allocation_heap"></a>1.8.3. Memory Allocation Heap</h4>
<div class="paragraph">
<p>If the heap is active (see <a href="#Memory-Allocation-Heap-2">section 2.9, &#8220;Memory Allocation Heap&#8221;</a>), an allocation heap chunk is written (&#8216;MAll&#8217;).
This chunk contains two four-byte values, plus two more for each extant memory block:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Heap start address</p>
</li>
<li>
<p>Number of extant blocks</p>
</li>
<li>
<p>Address of first block</p>
</li>
<li>
<p>Length of first block</p>
</li>
<li>
<p>Address of second block</p>
</li>
<li>
<p>Length of second block</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The blocks need not be listed in any particular order.</p>
</div>
<div class="paragraph">
<p>If the heap is not active, the &#8216;MAll&#8217; chunk can contain 0,0 or it may be omitted.</p>
</div>
</div>
<div class="sect3">
<h4 id="_associated_story_file"><a class="anchor" href="#_associated_story_file"></a>1.8.4. Associated Story File</h4>
<div class="paragraph">
<p>The contents of the game-file identifier (&#8216;IFhd&#8217; chunk) are simply the first 128 bytes of memory.
This is within ROM (since RAMSTART is at least 256), so it does not vary during play.
It includes the story file length and checksum, as well as any compiler-specific information that may be stored immediately after the header.</p>
</div>
</div>
<div class="sect3">
<h4 id="_state_not_saved"><a class="anchor" href="#_state_not_saved"></a>1.8.5. State Not Saved</h4>
<div class="paragraph">
<p>Some aspects of Glulx execution are not part of the save process, and therefore are not changed during a restart, restore, or restoreundo operation.
The program is responsible for checking these values after a restore to see if they have (from the program&#8217;s point of view) changed unexpectedly.</p>
</div>
<div class="paragraph">
<p>Examples of information which is not saved:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Glk library state.</p>
</li>
<li>
<p>This includes Glk opaque objects (windows, filerefs, streams).</p>
</li>
<li>
<p>It also includes I/O state such as the current output stream, contents of windows, and cursor positions.</p>
</li>
<li>
<p>Accounting for Glk object changes after restore/restoreundo is tricky, but absolutely necessary.</p>
</li>
<li>
<p>The protected-memory range (position, length, and whether it exists at all).</p>
</li>
<li>
<p>Note that the <em>contents</em> of the range (if it exists) are not treated specially during saving, and are therefore saved normally.</p>
</li>
<li>
<p>The random number generator&#8217;s internal state.</p>
</li>
<li>
<p>The I/O system mode and current string-decoding table address.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dictionary_of_opcodes"><a class="anchor" href="#_dictionary_of_opcodes"></a>2. Dictionary of Opcodes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Opcodes are written here in the format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">opname L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;where &#8220;L1&#8221; and &#8220;L2&#8221; are operands using the load addressing modes, and &#8220;S1&#8221; is an operand using the store addressing modes.
(See <a href="#_instruction_format">section 1.5, &#8220;Instruction Format&#8221;</a>.)</p>
</div>
<div class="paragraph">
<p>The table of opcodes:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Glulx Opcodes</caption>
<colgroup>
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x00</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nop</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x10</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>add</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x11</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sub</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x12</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mul</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x13</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>div</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x14</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mod</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x15</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>neg</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x18</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bitand</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x19</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bitor</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1A</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bitxor</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1B</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bitnot</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1C</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>shiftl</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1D</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sshiftr</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1E</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ushiftr</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x20</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jump</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x22</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jz</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x23</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jnz</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x24</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jeq</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x25</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jne</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x26</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jlt</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x27</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jge</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x28</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgt</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x29</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jle</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x2A</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jltu</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x2B</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgeu</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x2C</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgtu</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x2D</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jleu</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x30</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>call</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x31</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>return</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x32</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>catch</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x33</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>throw</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x34</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tailcall</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x40</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>copy</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x41</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>copys</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x42</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>copyb</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x44</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sexs</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x45</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sexb</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x48</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aload</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x49</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aloads</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x4A</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aloadb</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x4B</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aloadbit</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x4C</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>astore</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x4D</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>astores</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x4E</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>astoreb</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x4F</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>astorebit</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x50</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stkcount</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x51</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stkpeek</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x52</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stkswap</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x53</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stkroll</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x54</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stkcopy</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x70</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>streamchar</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x71</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>streamnum</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x72</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>streamstr</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x73</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>streamunichar</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x100</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gestalt</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x101</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>debugtrap</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x102</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getmemsize</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x103</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setmemsize</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x104</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jumpabs</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x110</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>random</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x111</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setrandom</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x120</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>quit</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x121</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>verify</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x122</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>restart</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x123</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>save</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x124</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>restore</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x125</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>saveundo</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x126</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>restoreundo</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x127</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>protect</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x130</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>glk</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x140</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getstringtbl</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x141</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setstringtbl</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x148</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getiosys</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x149</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setiosys</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x150</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>linearsearch</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x151</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>binarysearch</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x152</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>linkedsearch</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x160</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>callf</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x161</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>callfi</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x162</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>callfii</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x163</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>callfiii</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x170</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mzero</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x171</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mcopy</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x178</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>malloc</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x179</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mfree</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x180</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>accelfunc</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x181</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>accelparam</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x190</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>numtof</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x191</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ftonumz</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x192</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ftonumn</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x198</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ceil</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x199</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>floor</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1A0</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fadd</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1A1</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fsub</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1A2</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmul</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1A3</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fdiv</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1A4</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fmod</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1A8</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sqrt</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1A9</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>exp</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1AA</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>log</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1AB</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pow</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1B0</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sin</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1B1</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cos</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1B2</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tan</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1B3</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>asin</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1B4</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>acos</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1B5</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>atan</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1B6</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>atan2</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1C0</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jfeq</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1C1</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jfne</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1C2</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jflt</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1C3</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jfle</code></p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1C4</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jfgt</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1C5</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jfge</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1C8</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jisnan</code></p></td>
<th class="tableblock halign-right valign-top"><p class="tableblock">0x1C9</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jisinf</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Opcodes 0x1000 to 0x10FF are reserved for use by FyreVM.
Opcodes 0x1100 to 0x11FF are reserved for extension projects by Dannii Willis.
Opcodes 0x1200 to 0x12FF are reserved for iOS extension features by Andrew Plotkin.
These are not documented here.
Opcodes 0x7900 to 0x79FF are (apparently) reserved for experimental features in the Git interpreter.
See <a href="#_glulx_and_other_if_systems">Glulx and Other IF Systems</a>.</p>
</div>
<div class="sect2">
<h3 id="_integer_math"><a class="anchor" href="#_integer_math"></a>2.1. Integer Math</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">add L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add L1 and L2, using standard 32-bit addition.
Truncate the result to 32 bits if necessary.
Store the result in S1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">sub L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compute (L1 - L2), and store the result in S1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">mul L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compute (L1 * L2), and store the result in S1.
Truncate the result to 32 bits if necessary.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">div L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compute (L1 / L2), and store the result in S1.
This is signed integer division.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">mod L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compute (L1 % L2), and store the result in S1.
This is the remainder from signed integer division.</p>
</div>
<div class="paragraph">
<p>In division and remainer, signs are annoying.
Rounding is towards zero.
The sign of a remainder equals the sign of the dividend.
It is always true that (A / B) * B + (A % B) == A.
Some examples (in decimal):</p>
</div>
<div class="literalblock">
<div class="content">
<pre> 11 /  2 =  5
-11 /  2 = -5
 11 / -2 = -5
-11 / -2 =  5
 13 %  5 =  3
-13 %  5 = -3
 13 % -5 =  3
-13 % -5 = -3</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">neg L1 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compute the negative of L1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">bitand L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compute the bitwise AND of L1 and L2.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">bitor L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compute the bitwise OR of L1 and L2.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">bitxor L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compute the bitwise XOR of L1 and L2.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">bitnot L1 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compute the bitwise negation of L1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">shiftl L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Shift the bits of L1 to the left (towards more significant bits) by L2 places.
The bottom L2 bits are filled in with zeroes.
If L2 is 32 or more, the result is always zero.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">ushiftr L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Shift the bits of L1 to the right by L2 places.
The top L2 bits are filled in with zeroes.
If L2 is 32 or more, the result is always zero.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">sshiftr L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Shift the bits of L1 to the right by L2 places.
The top L2 bits are filled in with copies of the top bit of L1.
If L2 is 32 or more, the result is always zero or FFFFFFFF, depending on the top bit of L1.</p>
</div>
<div class="paragraph">
<p>Notes on the shift opcodes: If L2 is zero, the result is always equal to L1.
L2 is considered unsigned, so 80000000 or greater is &#8220;more than 32&#8221;.</p>
</div>
</div>
<div class="sect2">
<h3 id="_branches"><a class="anchor" href="#_branches"></a>2.2. Branches</h3>
<div class="paragraph">
<p>All branches (except <code>jumpabs</code>) specify their destinations with an offset value.
The actual destination address of the branch is computed as (Addr + Offset - 2), where Addr is the address of the instruction <em>after</em> the branch opcode, and offset is the branch&#8217;s operand.
The special offset values 0 and 1 are interpreted as &#8220;<code>return 0</code>&#8221; and &#8220;<code>return 1</code>&#8221; respectively.<sup class="footnote">[<a id="_footnoteref_6" class="footnote" href="#_footnotedef_6" title="View footnote.">6</a>]</sup></p>
</div>
<div class="paragraph">
<p>It is legal to branch to code that is in another function.<sup class="footnote">[<a id="_footnoteref_7" class="footnote" href="#_footnotedef_7" title="View footnote.">7</a>]</sup>
However, this does not affect the current stack frame; that remains set up according to the same function call as before the branch.
Similarly, it is legal to branch to code which is not associated with any function&#8201;&#8212;&#8201;e.g., code compiled on
the fly in RAM.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">jump L1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Branch unconditionally to offset L1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">jz L1 L2</code></pre>
</div>
</div>
<div class="paragraph">
<p>If L1 is equal to zero, branch to L2.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">jnz L1 L2</code></pre>
</div>
</div>
<div class="paragraph">
<p>If L1 is not equal to zero, branch to L2.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">jeq L1 L2 L3</code></pre>
</div>
</div>
<div class="paragraph">
<p>If L1 is equal to L2, branch to L3.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">jne L1 L2 L3</code></pre>
</div>
</div>
<div class="paragraph">
<p>If L1 is not equal to L2, branch to L3.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">jlt L1 L2 L3
jle L1 L2 L3
jgt L1 L2 L3
jge L1 L2 L3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Branch is L1 is less than, less than or equal to, greater than, greater than or equal to L2.
The values are compared as signed 32-bit values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">jltu L1 L2 L3
jleu L1 L2 L3
jgtu L1 L2 L3
jgeu L1 L2 L3</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same, except that the values are compared as unsigned 32-bit values.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Since the address space can span the full 32-bit range, it is wiser to compare addresses with the unsigned comparison operators.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">jumpabs L1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Branch unconditionally to address L1.
Unlike the other branch opcodes, this takes an absolute address, not an offset.
The special cases 0 and 1 (for returning) do not apply; <code>jumpabs</code> 0 would branch to memory address 0, if that were ever a good idea, which it isn&#8217;t.</p>
</div>
</div>
<div class="sect2">
<h3 id="_moving_data"><a class="anchor" href="#_moving_data"></a>2.3. Moving Data</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">copy L1 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read L1 and store it at S1, without change.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">copys L1 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read a 16-bit value from L1 and store it at S1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">copyb L1 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read an 8-bit value from L1 and store it at S1.</p>
</div>
<div class="paragraph">
<p>Since <code>copys</code> and <code>copyb</code> can access chunks smaller than the usual four bytes, they require some comment.
When reading from main memory or the call-frame locals, they access two or one bytes, instead of four.
However, when popping or pushing values on the stack, these opcodes pull or push a full 32-bit value.</p>
</div>
<div class="paragraph">
<p>Therefore, if <code>copyb</code> (for example) copies a byte from main memory to the stack, a 32-bit value will be pushed, whose value will be from 0 to 255.
Sign-extension <em>does not</em> occur.
Conversely, if <code>copyb</code> copies a byte from the stack to memory, a 32-bit value is popped, and the bottom 8 bits are written at the given address.
The upper 24 bits are lost.
Constant values are truncated as well.</p>
</div>
<div class="paragraph">
<p>If <code>copys</code> or <code>copyb</code> are used with both L1 and S1 in pop/push mode, the 32-bit value is popped, truncated, and pushed.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Since a call frame has no specified endianness, it is unwise to use these opcodes to pull out one or two bytes from a four-byte local variable.
The result will be implementation-dependent.
Therefore, use of the <code>copyb</code> and <code>copys</code> opcodes with a local-variable operand of different size is deprecated.
Since locals of less than four bytes are <em>also</em> deprecated, you should not use <code>copyb</code> or <code>copys</code> with local-variable operands at all.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">sexs L1 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sign-extend a value, considered as a 16-bit value.
If the value&#8217;s 8000 bit is set, the upper 16 bits are all set; otherwise, the upper 16 bits are all cleared.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">sexb L1 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sign-extend a value, considered as an 8-bit value.
If the value&#8217;s 80 bit is set, the upper 24 bits are all set; otherwise, the upper 24 bits are all cleared.</p>
</div>
<div class="paragraph">
<p>Note that these opcodes, like most, work on 32-bit values.
Although (for example) <code>sexb</code> is commonly used in conjunction with <code>copyb</code>, it does not share <code>copyb</code>&#8288;&#8217;s behavior of reading a single byte from memory or the locals.</p>
</div>
<div class="paragraph">
<p>Also note that the upper bits, 16 or 24 of them, are entirely ignored and overwritten with ones or zeroes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_array_data"><a class="anchor" href="#_array_data"></a>2.4. Array Data</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">astore L1 L2 L3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Store L3 into the 32-bit field at main memory address (L1+4*L2).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">aload L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Load a 32-bit value from main memory address (L1+4*L2), and store it in S1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">astores L1 L2 L3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Store L3 into the 16-bit field at main memory address (L1+2*L2).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">aloads L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Load an 16-bit value from main memory address (L1+2*L2), and store it in S1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">astoreb L1 L2 L3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Store L3 into the 8-bit field at main memory address (L1+L2).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">aloadb L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Load an 8-bit value from main memory address (L1+L2), and store it in S1.</p>
</div>
<div class="paragraph">
<p>Note that these opcodes cannot access call-frame locals, or the stack.
(Not with the L1 and L2 opcodes, that is.)
L1 and L2 provide a main-memory address.
Be not confused by the fact that L1 and L2 can be any addressing mode, including call-frame or stack-pop modes.
That controls where the values come from which are used to <em>compute</em> the main-memory address.</p>
</div>
<div class="paragraph">
<p>The other end of the transfer (S1 or L3) is always a 32-bit value.
The &#8220;store&#8221; opcodes truncate L3 to 8 or 16 bits if necessary.
The &#8220;load&#8221; opcodes expand 8-bit or 16-bit values <em>without</em> sign extension.
(If signed values are appropriate, you can follow <code>aloads</code>/<code>aloadb</code> with <code>sexs</code>/<code>sexb</code>.)</p>
</div>
<div class="paragraph">
<p>L2 is considered signed, so you can access addresses before L1 as well as after.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">astorebit L1 L2 L3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set or clear a single bit.
This is bit number (L2 mod 8) of memory address (L1+L2/8).
It is cleared if L3 is zero, set if nonzero.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">aloadbit L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Test a single bit, similarly.
If it is set, 1 is stored at S1; if clear, 0 is stored.</p>
</div>
<div class="paragraph">
<p>For these two opcodes, bits are effectively numbered sequentially, starting with the least significant bit of address L1.
L2 is considered signed, so this numbering extends both positively and negatively.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">astorebit  1002  0  1:  Set bit 0 of address 1002. (The 1's place.)
astorebit  1002  7  1:  Set bit 7 of address 1002. (The 128's place.)
astorebit  1002  8  1:  Set bit 0 of address 1003.
astorebit  1002  9  1:  Set bit 1 of address 1003.
astorebit  1002 -1  1:  Set bit 7 of address 1001.
astorebit  1002 -3  1:  Set bit 5 of address 1001.
astorebit  1002 -8  1:  Set bit 0 of address 1001.
astorebit  1002 -9  1:  Set bit 7 of address 1000.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Like the other <code>aload</code> and <code>astore</code> opcodes, these opcodes cannot access call-frame locals, or the stack.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_stack_2"><a class="anchor" href="#_the_stack_2"></a>2.5. The Stack</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">stkcount S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Store a count of the number of values on the stack.
This counts only values above the current call-frame.
In other words, it is always zero when a C1 function starts executing, and (numargs+1) when a C0 function starts executing.
It then increases and decreases thereafter as values are pushed and popped; it is always the number of values that can be popped legally.
(If S1 uses the stack push mode, the count is done before the result is pushed.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">stkpeek L1 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Peek at the L1&#8217;th value on the stack, without actually popping anything.
If L1 is zero, this is the top value; if one, it&#8217;s the value below that; etc.
L1 must be less than the current stack-count.
(If L1 or S1 use the stack pop/push modes, the peek is counted after L1 is popped, but before the result is pushed.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">stkswap</code></pre>
</div>
</div>
<div class="paragraph">
<p>Swap the top two values on the stack.
The current stack-count must be at least two.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">stkcopy L1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Peek at the top L1 values in the stack, and push duplicates onto the stack in the same order.
If L1 is zero, nothing happens.
L1 must not be greater than the current stack-count.
(If L1 uses the stack pop mode, the stkcopy is counted after L1 is popped.)</p>
</div>
<div class="paragraph">
<p>An example of stkcopy, starting with six values on the stack:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">5 4 3 2 1 0 &lt;top&gt;
stkcopy 3
5 4 3 2 1 0 2 1 0 &lt;top&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">stkroll L1 L2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rotate the top L1 values on the stack.
They are rotated up or down L2 places, with positive values meaning up and negative meaning down.
The current stack-count must be at least L1.
If either L1 or L2 is zero, nothing happens.
(If L1 and/or L2 use the stack pop mode, the roll occurs after they are popped.)</p>
</div>
<div class="paragraph">
<p>An example of two <code>stkrolls</code>, starting with nine values on the stack:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">8 7 6 5 4 3 2 1 0 &lt;top&gt;
stkroll 5 1
8 7 6 5 0 4 3 2 1 &lt;top&gt;
stkroll 9 -3
5 0 4 3 2 1 8 7 6 &lt;top&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>stkswap</code> is equivalent to <code>stkroll 2 1</code>, or for that matter <code>stkroll 2 -1</code>.
Also, <code>stkcopy 1</code> is equivalent to <code>stkpeek 0 sp</code>.</p>
</div>
<div class="paragraph">
<p>These opcodes can only access the values pushed on the stack above the current call-frame.
It is illegal to <code>stkswap</code>, <code>stkpeek</code>, <code>stkcopy</code>, or <code>stkroll</code> values below that&#8201;&#8212;&#8201;i.e, the locals segment or any previous function call frames.</p>
</div>
</div>
<div class="sect2">
<h3 id="_functions_2"><a class="anchor" href="#_functions_2"></a>2.6. Functions</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">call L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Call function whose address is L1, passing in L2 arguments, and store the return result at S1.</p>
</div>
<div class="paragraph">
<p>The arguments are taken from the stack.
Before you execute the <code>call</code> opcode, you must push the arguments on, in backward order (last argument pushed first, first argument topmost on the stack.)
The L2 arguments are removed before the new function&#8217;s call frame is constructed.
(If L1, L2, or S1 use the stack pop/push modes, the arguments are taken after L1 or L2 is popped, but before the result is pushed.)</p>
</div>
<div class="paragraph">
<p>Recall that all functions in Glulx have a single 32-bit return value.
If you do not care about the return value, you can use operand mode 0 (&#8220;discard value&#8221;) for operand S1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">callf L1 S1
callfi L1 L2 S1
callfii L1 L2 L3 S1
callfiii L1 L2 L3 L4 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Call function whose address is L1, passing zero, one, two, or three arguments.
Store the return result at S1.</p>
</div>
<div class="paragraph">
<p>These opcodes behave the same as <code>call</code>, except that the arguments are given in the usual opcode format instead of being found on the stack.
(If L2, L3, etc. all use the stack pop mode, then the behavior is exactly the same as <code>call</code>.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">return L1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Return from the current function, with the given return value.
If this is the top-level function, Glulx execution is over.</p>
</div>
<div class="paragraph">
<p>Note that all the branch opcodes (<code>jump</code>, <code>jz</code>, <code>jeq</code>, and so on) have an option to return 0 or 1 instead of branching.
These behave exactly as if the <code>return</code> opcode had been executed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">tailcall L1 L2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Call function whose address is L1, passing in L2 arguments, and pass the return result out to whoever called the current function.</p>
</div>
<div class="paragraph">
<p>This destroys the current call-frame, as if a return had been executed, but does not touch the call stub below that.
It then immediately calls L1, creating a new call-frame.
The effect is the same as a call immediately followed by a return, but takes less stack space.</p>
</div>
<div class="paragraph">
<p>It is legal to use <code>tailcall</code> from the top-level function.
L1 becomes the top-level function.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This opcode can be used to implement tail recursion, without forcing the stack to grow with every call.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_continuations"><a class="anchor" href="#_continuations"></a>2.7. Continuations</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">catch S1 L1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Generates a &#8220;catch token&#8221;, which can be used to jump back to this execution point from a <code>throw</code> opcode.
The token is stored in S1, and then execution branches to offset L1.
If execution is proceeding from this point because of a throw, the thrown value is stored instead, and the branch is ignored.</p>
</div>
<div class="paragraph">
<p>Remember if the branch value is not 0 or 1, the branch is to to (Addr + L1 - 2), where Addr is the address of the instruction <em>after</em> the catch.
If the value <em>is</em> 0 or 1, the function returns immediately, invalidating the catch token.</p>
</div>
<div class="paragraph">
<p>If S1 or L1 uses the stack push/pop modes, note that the precise order of execution is: evaluate L1 (popping if appropriate); generate a call stub and compute the token; store S1 (pushing if appropriate).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">throw L1 L2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Jump back to a previously-executed <code>catch</code> opcode, and store the value L1.
L2 must be a valid catch token.</p>
</div>
<div class="paragraph">
<p>The exact <code>catch</code>/<code>throw</code> procedure is as follows:</p>
</div>
<div class="paragraph">
<p>When catch is executed, a four-value call stub is pushed on the stack&#8201;&#8212;&#8201;result destination, PC, and FramePtr.
(See <a href="#_call_stubs">section 1.3.2, &#8220;Call Stubs&#8221;</a>.
The PC is the address of the next instruction after the catch.)
The catch token is the value of the stack pointer after these are pushed.
The token value is stored in the result destination, and execution proceeds, branching to L1.</p>
</div>
<div class="paragraph">
<p>When <code>throw</code> is executed, the stack is popped down until the stack pointer equals the given token.
Then the four values are read back off the stack, the thrown value is stored in the destination, and execution proceeds with the instruction after the catch.</p>
</div>
<div class="paragraph">
<p>If the call stub (or any part of it) is removed from the stack, the catch token becomes invalid, and must not be used.
This will certainly occur when you return from the function containing the <code>catch</code> opcode.
It will also occur if you pop too many values from the stack after executing the catch.
(You may wish to do this to &#8220;cancel&#8221; the catch; if you pop and discard those four values, the token is invalidated, and it is as if you had never executed the catch at all.)
The catch token is also invalidated if any part of the call stub is overwritten (e.g. with <code>stkswap</code> or <code>stkroll</code>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Why is the catch branch taken at catch time, and ignored after a throw?
Because it&#8217;s easier to write the interpreter that way, that&#8217;s why.
If it had to branch after a throw, either the call stub would have to contain the branch offset, or the terp would have to re-parse the catch instruction.
Both are ugly.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_memory_map"><a class="anchor" href="#_memory_map"></a>2.8. Memory Map</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">getmemsize S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Store the current size of the memory map.
This is originally the ENDMEM value from the header, but you can change it with the <code>setmemsize</code> opcode.
(The <code>malloc</code> and <code>mfree</code> opcodes may also cause this value to change; see <a href="#Memory-Allocation-Heap-2">section 2.9, &#8220;Memory Allocation Heap&#8221;</a>.)
It will always be greater than or equal to ENDMEM, and will always be a multiple of 256.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">setmemsize L1 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set the current size of the memory map.
The new value must be a multiple of 256, like all memory boundaries in Glulx.
It must be greater than or equal to ENDMEM (the initial memory-size value which is stored in the header.)
It does not have to be greater than the previous memory size.
The memory size may grow and shrink over time, as long as it never gets smaller than the initial size.</p>
</div>
<div class="paragraph">
<p>When the memory size grows, the new space is filled with zeroes.
When it shrinks, the contents of the old space are lost.</p>
</div>
<div class="paragraph">
<p>If the allocation heap is active (see <a href="#Memory-Allocation-Heap-2">section 2.9, &#8220;Memory Allocation Heap&#8221;</a>) you may not use <code>setmemsize</code>&#8201;&#8212;&#8201;the memory map is under the control of the heap system.
If you free all heap objects, the heap will then no longer be active, and you can use <code>setmemsize</code>.</p>
</div>
<div class="paragraph">
<p>Since memory allocation is never guaranteed, you must be prepared for the possibility that <code>setmemsize</code> will fail.
The opcode stores the value zero if it succeeded, and 1 if it failed.
If it failed, the memory size is unchanged.</p>
</div>
<div class="paragraph">
<p>Some interpreters do not have the capability to resize memory at all.
On such interpreters, <code>setmemsize</code> will <em>always</em> fail.
You can check this in advance with the <code>ResizeMem</code> gestalt selector.</p>
</div>
<div class="paragraph">
<p>Note that the memory size is considered part of the game state.
If you restore a saved game, the current memory size is changed to the size that was in effect when the game was saved.
If you restart, the current memory size is reset to its initial value.</p>
</div>
</div>
<div class="sect2">
<h3 id="Memory-Allocation-Heap-2"><a class="anchor" href="#Memory-Allocation-Heap-2"></a>2.9. Memory Allocation Heap</h3>
<div class="paragraph">
<p>Manage the memory allocation heap.</p>
</div>
<div class="paragraph">
<p>Glulx is able to maintain a list of dynamically-allocated memory objects.
These objects exist in the memory map, above ENDMEM.
The <code>malloc</code> and <code>mfree</code> opcodes allow the game to request the allocation and destruction of these objects.</p>
</div>
<div class="paragraph">
<p>Some interpreters do not have the capability to manage an allocation heap.
On such interpreters, malloc will always fail.
You can check this in advance with the <code>MAlloc</code> gestalt selector.</p>
</div>
<div class="paragraph">
<p>When you first allocate a block of memory, the heap becomes active.
The current end of memory&#8201;&#8212;&#8201;that is, the current getmemsize value&#8201;&#8212;&#8201;becomes the beginning address of the heap.
The memory map is then extended to accomodate the memory block.</p>
</div>
<div class="paragraph">
<p>Subsequent memory allocations and deallocations are done within the heap.
The interpreter may extend or reduce the memory map, as needed, when allocations and deallocations occur.
While the heap is active, you may not manually resize the memory map with setmemsize; the heap system is responsible for doing that.</p>
</div>
<div class="paragraph">
<p>When you free the last extant memory block, the heap becomes inactive.
The interpreter will reduce the memory map size down to the heap-start address.
(That is, the getmemsize value returns to what it was before you allocated the first block.)
Thereafter, it is legal to call setmemsize again.</p>
</div>
<div class="paragraph">
<p>It is legitimate to read or write any memory address in the heap range (from ENDMEM to the end of the memory map).
You are not restricted to extant blocks.<sup class="footnote">[<a id="_footnoteref_8" class="footnote" href="#_footnotedef_8" title="View footnote.">8</a>]</sup></p>
</div>
<div class="paragraph">
<p>The heap state (whether it is active, its starting address, and the addresses and sizes of all extant blocks) <em>is</em> part of the saved game state.</p>
</div>
<div class="paragraph">
<p>These opcodes were added in Glulx version 3.1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">malloc L1 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Allocate a memory block of L1 bytes.
(L1 must be positive.)
This stores the address of the new memory block, which will be within the heap and will not overlap any other extant block.
The interpreter may have to extend the memory map (see <a href="#_memory_map">section 2.8, &#8220;Memory Map&#8221;</a>) to accomodate the new block.</p>
</div>
<div class="paragraph">
<p>This operation does not change the contents of the memory block (or, indeed, the contents of the memory map at all).
If you want the memory block to be initialized, you must do it yourself.</p>
</div>
<div class="paragraph">
<p>If the allocation fails, this stores zero.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">mfree L1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Free the memory block at address L1.
This <em>must</em> be the address of an extant block&#8201;&#8212;&#8201;that is, a value returned by malloc and not previously freed.</p>
</div>
<div class="paragraph">
<p>This operation does not change the contents of the memory block (or, indeed, the contents of the memory map at all).</p>
</div>
</div>
<div class="sect2">
<h3 id="_game_state"><a class="anchor" href="#_game_state"></a>2.10. Game State</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">quit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Shut down the terp and exit.
This is equivalent to returning from the top-level function, or for that matter calling <code>glk_exit()</code>.</p>
</div>
<div class="paragraph">
<p>Note that (in the Glk I/O system)
Glk is responsible for any &#8220;hit any key to exit&#8221; prompt.
It is safe for you to print a bunch of final text and then exit immediately.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">restart</code></pre>
</div>
</div>
<div class="paragraph">
<p>Restore the VM to its initial state (memory, stack, and registers).
Note that the current memory size is reset, as well as the contents of memory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">save L1 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Save the VM state to the output stream L1.
It is your responsibility to prompt the player for a filespec, open the stream, and then destroy these objects afterward.
S1 is set to zero if the operation succeeded, 1 if it failed, and -1 if the VM has just been restored and is continuing from this instruction.</p>
</div>
<div class="paragraph">
<p>(In the Glk I/O system, L1 should be the ID of a writable Glk stream.
In other I/O systems, it will mean something different.
In the &#8220;filter&#8221; and &#8220;null&#8221; I/O systems, the <code>save</code> opcode is illegal, as the interpreter has nowhere to write the state.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">restore L1 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Restore the VM state from the input stream L1.
S1 is set to 1 if the operation failed.
If it succeeded, of course, this instruction never returns a value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">saveundo S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Save the VM state in a temporary location.
The terp will choose a location appropriate for rapid access, so this may be called once per turn.
S1 is set to zero if the operation succeeded, 1 if it failed, and -1 if the VM state has just been restored.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">restoreundo S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Restore the VM state from temporary storage.
S1 is set to 1 if the operation failed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">protect L1 L2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Protect a range of memory from restart, restore, restoreundo.
The protected range starts at address L1 and has a length of L2 bytes.
This memory is silently unaffected by the state-restoring operations.
(However, if the result-storage S1 is directed into the protected range, that is not blocked.)</p>
</div>
<div class="paragraph">
<p>When the VM starts up, there is no protection range.
Only one range can be protected at a time.
Calling protect cancels any previous range.
To turn off protection, call protect with L1 and L2 set to zero.</p>
</div>
<div class="paragraph">
<p>It is important to note that the protection range itself (its existence, location, and length) is <em>not</em> part of the saved game state!
If you save a game, move the protection range to a new location, and then restore that game, it is the new range that will be protected, and the range will remain there afterwards.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">verify S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Perform sanity checks on the game file, using its length and checksum.
S1 is set to zero if everything looks good, 1 if there seems to be a problem.
(Many interpreters will do this automatically, before the game starts executing.
This opcode is provided mostly for slower interpreters, where auto-verify might cause an unacceptable delay.)</p>
</div>
<div class="paragraph">
<p>Notes:</p>
</div>
<div class="paragraph">
<p>All the save and restore opcodes can generate diagnostic information on the current output stream.</p>
</div>
<div class="paragraph">
<p>A terp may support several levels of temporary storage.
You should not make any assumptions about how many times <code>restoreundo</code> can be called.
If the player so requests, you should keep calling it until it fails.</p>
</div>
<div class="paragraph">
<p>Glk opaque objects (windows, streams, filespecs) are not part of the saved game state.
Therefore, when you restore a game, all the object IDs you have in Glulx memory must be considered invalid.
(This includes both IDs in main memory and on the stack.)
You must use the Glk iteration calls to go through all the opaque objects in existence, and recognize them by their rocks.</p>
</div>
<div class="paragraph">
<p>The same applies after <code>restoreundo</code>, to a lesser extent.
Since <code>saveundo</code>/<code>restoreundo</code> only operate within a single play session, you can rely on the IDs of objects created before the first saveundo.
However, if you have created any objects since then, you must iterate and recognize them.</p>
</div>
<div class="paragraph">
<p>The <code>restart</code> opcode is a similar case.
You must do an iteration as soon as your program starts, to find objects created in an earlier incarnation.
Alternatively, you can be careful to close all opaque objects before invoking <code>restart</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Another approach is to use the <code>protect</code> opcode, to preserve global variables containing your object IDs.
This will work within a play session&#8201;&#8212;&#8201;that is, with <code>saveundo</code>, <code>restoreundo</code>, and <code>restart</code>.
You must still deal with <code>save</code> and <code>restore</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Output"><a class="anchor" href="#Output"></a>2.11. Output</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">getiosys S1 S2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Return the current I/O system mode and rock.</p>
</div>
<div class="paragraph">
<p>Due to a long-standing bug in the reference interpreter, the two store operands must be of the same general type: both main-memory/global stores, both local variable stores, or both stack pushes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">setiosys L1 L2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set the I/O system mode and rock.
If the system L1 is not supported by the interpreter, it will default to the &#8220;null&#8221; system (0).</p>
</div>
<div class="paragraph">
<p>These systems are currently defined:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0: The null system.
All output is discarded.
(When the Glulx machine starts up, this is the current system.)</p>
</li>
<li>
<p>1: The filtering system.
The rock (L2) value should be the address of a Glulx function.
This function will be called for every character output (with the character value as its sole argument).
The function&#8217;s return value is ignored.</p>
</li>
<li>
<p>2: The Glk system.
All output will be handled through Glk function calls, sent to the current Glk stream.</p>
</li>
<li>
<p>20: The FyreVM channel system.
See <a href="#_glulx_and_other_if_systems">Glulx and Other IF Systems</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is important to recall that when Glulx starts up, the Glk I/O system is <em>not</em> set.
And when Glk starts up, there are no windows and no current output stream.
To make anything appear to the user, you must first do three things: select the Glk I/O system, open a Glk window, and set its stream as the current one.
(It is illegal in Glk to send output when there is no stream set.
Sending output to Glulx&#8217;s &#8220;null&#8221; I/O system is legal, but pointless.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">streamchar L1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Send L1 to the current stream.
This sends a single character; the value L1 is truncated to eight bits.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">streamunichar L1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Send L1 to the current stream.
This sends a single (32-bit) character.</p>
</div>
<div class="paragraph">
<p>This opcode was added in Glulx version 3.0.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">streamnum L1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Send L1 to the current stream, represented as a signed decimal number in ASCII.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">streamstr L1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Send a string object to the current stream.
L1 must be the address of a Glulx string object (type E0, E1, or E2.)
The string is decoded and sent as a sequence of characters.</p>
</div>
<div class="paragraph">
<p>When the Glk I/O system is set, these opcodes are implemented using the Glk API.
You can bypass them and directly call <code>glk_put_char()</code>, <code>glk_put_buffer()</code>, and so on.
Remember, however, that <code>glk_put_string()</code> only accepts unencoded string (E0) objects; <code>glk_put_string_uni()</code> only accepts unencoded Unicode (E2) objects.</p>
</div>
<div class="paragraph">
<p>Note that it is illegal to decode a compressed string (E1) if there is no string-decoding table set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">getstringtbl S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Return the address the terp is currently using for its string-decoding table.
If there is no table, set, this returns zero.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">setstringtbl L1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Change the address the terp is using for its string-decoding table.
This may be zero, indicating that there is no table (in which case it is illegal to print any compressed string).
Otherwise, it must be the address of a <em>valid</em> string-decoding table.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This does not change the value in the header field at address 001C.
The header is in ROM, and never changes.
To determine the current table address, use the <code>getstringtbl</code> opcode.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A string-decoding table may be in RAM or ROM, but there may be speed penalties if it is in RAM.
See <a href="#_the_string_decoding_table">section 1.6.1.4, &#8220;The String-Decoding Table&#8221;</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_floating_point_math"><a class="anchor" href="#_floating_point_math"></a>2.12. Floating-Point Math</h3>
<div class="paragraph">
<p>Recall that floating-point values are encoded as single-precision (32-bit) IEEE-754 values (see <a href="#_floating_point_numbers">section 1.7, &#8220;Floating-Point Numbers&#8221;</a>).
The interpreter must convert values (from memory or the stack) before performing a floating-point operation, and unconvert them afterwards.<sup class="footnote">[<a id="_footnoteref_9" class="footnote" href="#_footnotedef_9" title="View footnote.">9</a>]</sup></p>
</div>
<div class="paragraph">
<p>Float operations which produce inexact results are not guaranteed to be identical on every platform.
That is, 1.0 plus 1.0 will always be 2.0, because that can be represented exactly.
But <code>acos(-1.0)</code>, which should be pi, may generate either 40490FDA (3.14159250&#8230;&#8203;) or 40490FDB (3.14159274&#8230;&#8203;).
Both are approximations of the correct result, but which one you get depends on the interpreter&#8217;s underlying math library.</p>
</div>
<div class="paragraph">
<p>If any argument to a float operation is a NaN (&#8220;not a number&#8221;) value, the result will be a NaN value.
(Except for the <code>pow</code> opcode, which has some special cases.)<sup class="footnote">[<a id="_footnoteref_10" class="footnote" href="#_footnotedef_10" title="View footnote.">10</a>]</sup></p>
</div>
<div class="paragraph">
<p>These opcodes were added in Glulx version 3.1.2.
However, not all interpreters may support them.
You can test for their availability with the <code>Float</code> gestalt selector.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">numtof L1 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Convert an integer value to the closest equivalent float.
(That is, if L1 is 1, then 3F800000&#8201;&#8212;&#8201;the float encoding of 1.0&#8201;&#8212;&#8201;will be stored in S1.)
Integer zero is converted to (positive) float zero.</p>
</div>
<div class="paragraph">
<p>If the value is less than -1000000 or greater than 1000000 (hex), the conversion may not be exact.
(More specifically, it may round to a nearby multiple of a power of 2.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">ftonumz L1 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Convert a float value to an integer, rounding towards zero (i.e., truncating the fractional part).
If the value is outside the 32-bit integer range, or is NaN or infinity, the result will be 7FFFFFFF (for positive values) or 80000000 (for negative values).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">ftonumn L1 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Convert a float value to an integer, rounding towards the nearest integer.
Again, overflows become 7FFFFFFF or 80000000.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">fadd L1 L2 S1
fsub L1 L2 S1
fmul L1 L2 S1
fdiv L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Perform floating-point arithmetic.
Overflows produce infinite values (with the appropriate sign); underflows produce zero values (ditto). 0/0 is NaN.
Inf/Inf, or Inf-Inf, is NaN.
Any finite number added to infinity is infinity.
Any nonzero number divided by an infinity, or multiplied by zero, is a zero.
Any nonzero number multiplied by an infinity, or divided by zero, is an infinity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">fmod L1 L2 S1 S2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Perform a floating-point modulo operation.
S1 is the remainder (or modulus); S2 is the quotient.</p>
</div>
<div class="paragraph">
<p>S2 is L1/L2, rounded (towards zero) to an integral value.
S1 is L1-(S2*L2).
Note that S1 always has the same sign as L1; S2 has the appropriate sign for L1/L2.</p>
</div>
<div class="paragraph">
<p>If L2 is 1, this gives you the fractional and integer parts of L1.
If L1 is zero, both results are zero.
If L2 is infinite, S1 is L1 and S2 is zero.
If L1 is infinite or L2 is zero, both results are NaN.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">ceil L1 S1
floor L1 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Round L1 up (towards +Inf) or down (towards -Inf) to the nearest integral value.
(The result is still in float format, however.)
These opcodes are idempotent.</p>
</div>
<div class="paragraph">
<p>The result keeps the sign of L1; in particular, <code>floor(0.5)</code> is 0 and <code>ceil(-0.5)</code> is -0.
Rounding -0 up or down gives -0.
Rounding an infinite value gives infinity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">sqrt L1 S1
exp L1 S1
log L1 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compute the square root of L1, e^L1, and log of L1 (base e).</p>
</div>
<div class="paragraph">
<p>sqrt(-0) is -0. sqrt returns NaN for all other negative values. exp(+0) and exp(-0) are 1; exp(-Inf) is +0. log(+0) and log(-0) are -Inf. log returns NaN for all other negative values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">pow L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compute L1 raised to the L2 power.</p>
</div>
<div class="paragraph">
<p>The special cases are breathtaking.
The following is quoted (almost) directly from the libc man page:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>pow(+-0, y) returns +-Inf for y an odd integer &lt; 0.</p>
</li>
<li>
<p>pow(+-0, y) returns +Inf for y &lt; 0 and not an odd integer.</p>
</li>
<li>
<p>pow(+-0, y) returns +-0 for y an odd integer &gt; 0.</p>
</li>
<li>
<p>pow(+-0, y) returns +0 for y &gt; 0 and not an odd integer.</p>
</li>
<li>
<p>pow(-1, +-Inf) returns 1.</p>
</li>
<li>
<p>pow(1, y) returns 1 for any y, even a NaN.</p>
</li>
<li>
<p>pow(x, +-0) returns 1 for any x, even a NaN.</p>
</li>
<li>
<p>pow(x, y) returns a NaN for finite x &lt; 0 and finite non-integer y.</p>
</li>
<li>
<p>pow(x, -Inf) returns +Inf for |x| &lt; 1.</p>
</li>
<li>
<p>pow(x, -Inf) returns +0 for |x| &gt; 1.</p>
</li>
<li>
<p>pow(x, +Inf) returns +0 for |x| &lt; 1.</p>
</li>
<li>
<p>pow(x, +Inf) returns +Inf for |x| &gt; 1.</p>
</li>
<li>
<p>pow(-Inf, y) returns -0 for y an odd integer &lt; 0.</p>
</li>
<li>
<p>pow(-Inf, y) returns +0 for y &lt; 0 and not an odd integer.</p>
</li>
<li>
<p>pow(-Inf, y) returns -Inf for y an odd integer &gt; 0.</p>
</li>
<li>
<p>pow(-Inf, y) returns +Inf for y &gt; 0 and not an odd integer.</p>
</li>
<li>
<p>pow(+Inf, y) returns +0 for y &lt; 0.</p>
</li>
<li>
<p>pow(+Inf, y) returns +Inf for y &gt; 0.</p>
</li>
<li>
<p>pow(x, y) returns NaN if x is negative and y is not an integer (both finite).</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">sin L1 S1
cos L1 S1
tan L1 S1
acos L1 S1
asin L1 S1
atan L1 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compute the standard trigonometric functions.</p>
</div>
<div class="paragraph">
<p>sin and cos return values in the range -1 to 1. sin, cos, and tan of infinity are NaN.</p>
</div>
<div class="paragraph">
<p>asin is always in the range -pi/2 to pi/2; acos is always in the range 0 to pi. asin and acos of values greater than 1, or less than -1, are NaN. atan(+-Inf) is +-pi/2.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">atan2 L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Computes the arctangent of L1/L2, using the signs of both arguments to determine the quadrant of the return value.
(Note that the Y argument is first and the X argument is second.)</p>
</div>
<div class="paragraph">
<p>Again with the special cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>atan2(+-0, -0) returns +-pi.</p>
</li>
<li>
<p>atan2(+-0, +0) returns +-0.</p>
</li>
<li>
<p>atan2(+-0, x) returns +-pi for x &lt; 0.</p>
</li>
<li>
<p>atan2(+-0, x) returns +-0 for x &gt; 0.</p>
</li>
<li>
<p>atan2(y, +-0) returns +pi/2 for y &gt; 0.</p>
</li>
<li>
<p>atan2(y, +-0) returns -pi/2 for y &lt; 0.</p>
</li>
<li>
<p>atan2(+-y, -Inf) returns +-pi for finite y.</p>
</li>
<li>
<p>atan2(+-y, +Inf) returns +-0 for finite y.</p>
</li>
<li>
<p>atan2(+-Inf, x) returns +-pi/2 for finite x.</p>
</li>
<li>
<p>atan2(+-Inf, -Inf) returns +-3*pi/4.</p>
</li>
<li>
<p>atan2(+-Inf, +Inf) returns +-pi/4.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_floating_point_comparisons"><a class="anchor" href="#_floating_point_comparisons"></a>2.13. Floating-Point Comparisons</h3>
<div class="paragraph">
<p>All these branch opcodes specify their destinations with an offset value.
See <a href="#_branches">section 2.2, &#8220;Branches&#8221;</a>.</p>
</div>
<div class="paragraph">
<p>Most of these opcodes never branch if any argument is NaN.
(Exceptions are <code>jisnan</code> and <code>jfne</code>.)
In particular, NaN is neither less than, greater than, nor equal to NaN.</p>
</div>
<div class="paragraph">
<p>These opcodes were added in Glulx version 3.1.2.
However, not all interpreters may support them.
You can test for their availability with the <code>Float</code> gestalt selector.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">jisnan L1 L2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Branch to L2 if the floating-point value L1 is a NaN value.
(See <a href="#_floating_point_numbers">section 1.7, &#8220;Floating-Point Numbers&#8221;</a>.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">jisinf L1 L2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Branch to L2 if the floating-point value L1 is an infinity (7F800000 or FF800000).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">jfeq L1 L2 L3 L4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Branch to L4 if the difference between L1 and L2 is less than or equal to (plus or minus)
L3.
The sign of L3 is ignored.</p>
</div>
<div class="paragraph">
<p>If any of the arguments are NaN, this will not branch.
If L3 is infinite, this will always branch&#8201;&#8212;&#8201;unless L1 and L2 are opposite infinities.
(Opposite infinities are never equal, regardless of L3.
Infinities of the same sign are always equal.)</p>
</div>
<div class="paragraph">
<p>If L3 is (plus or minus) zero, this tests for exact equality.
Note that +0 is considered exactly equal to -0.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">jfne L1 L2 L3 L4</code></pre>
</div>
</div>
<div class="paragraph">
<p>The reverse of jfeq.
This <em>will</em> branch if <em>any</em> of the arguments is NaN.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">jflt L1 L2 L3
jfle L1 L2 L3
jfgt L1 L2 L3
jfge L1 L2 L3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Branch to L3 if L1 is less than (less than or equal to, greater than, greater than or equal to) L2.</p>
</div>
<div class="paragraph">
<p>+0 and -0 behave identically in comparisons.
In particular, +0 is considered equal to -0, not greater than -0.</p>
</div>
</div>
<div class="sect2">
<h3 id="_random_number_generator"><a class="anchor" href="#_random_number_generator"></a>2.14. Random Number Generator</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">random L1 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Return a random number in the range 0 to (L1-1); or, if L1 is negative, the range (L1+1) to 0.
If L1 is zero, return a random number in the full 32-bit integer range.
(Remember that this may be either positive or negative.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">setrandom L1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Seed the random-number generator with the value L1.
If L1 is zero, subsequent random numbers will be as genuinely unpredictable as the terp can provide; it may include timing data or other random sources in its generation.
If L1 is nonzero, subsequent random numbers will follow a deterministic sequence, always the same for a given nonzero seed.</p>
</div>
<div class="paragraph">
<p>The terp starts up in the &#8220;nondeterministic&#8221; mode (as if setrandom 0 had been invoked.)</p>
</div>
<div class="paragraph">
<p>The random-number generator is not part of the saved-game state.</p>
</div>
</div>
<div class="sect2">
<h3 id="_block_copy_and_clear"><a class="anchor" href="#_block_copy_and_clear"></a>2.15. Block Copy and Clear</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">mzero L1 L2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Write L1 zero bytes, starting at address L2.
This is exactly equivalent to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">for (ix=0: ix&lt;L1: ix++) L2-&gt;ix = 0;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">mcopy L1 L2 L3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy L1 bytes from address L2 to address L3.
It is safe to copy a block to an overlapping block.
This is exactly equivalent to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">if (L3 &lt; L2)
  for (ix=0: ix&lt;L1: ix++) L3-&gt;ix = L2-&gt;ix;
else
  for (ix=L1-1: ix&gt;=0: ix--) L3-&gt;ix = L2-&gt;ix;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For both of these opcodes, L1 may be zero, in which case the opcodes do nothing.
The operands are considered unsigned, so a &#8220;negative&#8221; L1 is a very large number (and almost certainly a mistake).</p>
</div>
<div class="paragraph">
<p>These opcodes were added in Glulx version 3.1.
You can test for their availability with the <code>MemCopy</code> gestalt selector.</p>
</div>
</div>
<div class="sect2">
<h3 id="_searching"><a class="anchor" href="#_searching"></a>2.16. Searching</h3>
<div class="paragraph">
<p>Perform a generic linear, binary, or linked-list search.<sup class="footnote">[<a id="_footnoteref_11" class="footnote" href="#_footnotedef_11" title="View footnote.">11</a>]</sup></p>
</div>
<div class="paragraph">
<p>All three of these opcodes operate on a collection of fixed-size data structures in memory.
A key, which is a fixed-length array of bytes, is found at a known position within each data structure.
The opcodes search the collection of structures, and find one whose key matches a given key.</p>
</div>
<div class="paragraph">
<p>The following flags may be set in the Options argument.
Note that not all flags can be used with all types of searches.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>KeyIndirect</code> (0x01): This flag indicates that the <code>Key</code> argument passed to the opcode is the address of the actual key.
If this flag is not used, the <code>Key</code> argument is the key value itself.
(In this case, the <code>KeySize</code> <em>must</em> be 1, 2, or 4&#8201;&#8212;&#8201;the native sizes of Glulx values.
If the <code>KeySize</code> is 1 or 2, the lower bytes of the Key are used and the upper bytes ignored.)</p>
</li>
<li>
<p><code>ZeroKeyTerminates</code> (0x02): This flag indicates that the search should stop (and return failure) if it encounters a structure whose key is all zeroes.
If the searched-for key happens to also be all zeroes, the success takes precedence.</p>
</li>
<li>
<p><code>ReturnIndex</code> (0x04): This flag indicates that search should return the array index of the structure that it finds, or -1 (0xFFFFFFFF) for failure.
If this flag is not used, the search returns the address of the structure that it finds, or 0 for failure.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">linearsearch L1 L2 L3 L4 L5 L6 L7 S1</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>L1: Key</p>
</li>
<li>
<p>L2: KeySize</p>
</li>
<li>
<p>L3: Start</p>
</li>
<li>
<p>L4: StructSize</p>
</li>
<li>
<p>L5: NumStructs</p>
</li>
<li>
<p>L6: KeyOffset</p>
</li>
<li>
<p>L7: Options</p>
</li>
<li>
<p>S1: Result</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An array of data structures is stored in memory, beginning at Start, each structure being <code>StructSize</code> bytes.
Within each struct, there is a key value <code>KeySize</code> bytes long, starting at position <code>KeyOffset</code> (from the start of the structure.)
Search through these in order.
If one is found whose key matches, return it.
If <code>NumStructs</code> are searched with no result, the search fails.</p>
</div>
<div class="paragraph">
<p><code>NumStructs</code> may be -1 (0xFFFFFFFF) to indicate no upper limit to the number of structures to search.
The search will continue until a match is found, or (if <code>ZeroKeyTerminates</code> is used) a zero key.</p>
</div>
<div class="paragraph">
<p>The <code>KeyIndirect</code>, <code>ZeroKeyTerminates</code>, and <code>ReturnIndex</code> options may be used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">binarysearch L1 L2 L3 L4 L5 L6 L7 S1</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>L1: Key</p>
</li>
<li>
<p>L2: KeySize</p>
</li>
<li>
<p>L3: Start</p>
</li>
<li>
<p>L4: StructSize</p>
</li>
<li>
<p>L5: NumStructs</p>
</li>
<li>
<p>L6: KeyOffset</p>
</li>
<li>
<p>L7: Options</p>
</li>
<li>
<p>S1: Result</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An array of data structures is in memory, as above.
However, the structs must be stored in forward order of their keys (taking each key to be a big-endian unsigned integer.)
There can be no duplicate keys.
<code>NumStructs</code> must indicate the exact length of the array; it cannot be -1.</p>
</div>
<div class="paragraph">
<p>The <code>KeyIndirect</code> and <code>ReturnIndex</code> options may be used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">linkedsearch L1 L2 L3 L4 L5 L6 S1</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>L1: Key</p>
</li>
<li>
<p>L2: KeySize</p>
</li>
<li>
<p>L3: Start</p>
</li>
<li>
<p>L4: KeyOffset</p>
</li>
<li>
<p>L5: NextOffset</p>
</li>
<li>
<p>L6: Options</p>
</li>
<li>
<p>S1: Result</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The structures need not be consecutive; they may be anywhere in memory, in any order.
They are linked by a four-byte address field, which is found in each struct at position <code>NextOffset</code>.
If this field contains zero, it indicates the end of the linked list.</p>
</div>
<div class="paragraph">
<p>The <code>KeyIndirect</code> and <code>ZeroKeyTerminates</code> options may be used.</p>
</div>
</div>
<div class="sect2">
<h3 id="_accelerated_functions"><a class="anchor" href="#_accelerated_functions"></a>2.17. Accelerated Functions</h3>
<div class="paragraph">
<p>To improve performance, Glulx incorporates some complex functions which replicate code in the Inform library.<sup class="footnote">[<a id="_footnoteref_12" class="footnote" href="#_footnotedef_12" title="View footnote.">12</a>]</sup></p>
</div>
<div class="paragraph">
<p>Rather than allocating a new opcode for each function, Glulx offers an expandable function acceleration system.
Two functions are defined below.
The game may request that a particular address&#8201;&#8212;&#8201;the address of a VM function&#8201;&#8212;&#8201;be replaced by one of the available functions.
This does not alter memory; but any subsequent call to that address might invoke the terp&#8217;s built-in version of the function, instead of the VM code at that address.</p>
</div>
<div class="paragraph">
<p>(A &#8220;call&#8221; includes any function invocation of that address, including the <code>call</code>, <code>tailcall</code>, and <code>callf</code> (etc.) opcodes.
It also includes invocation via the filter I/O system, and function nodes in the string-decoding table.
Branches to the address are <em>not</em> affected; neither are returns, throws, or other ways the terp might reach it.)</p>
</div>
<div class="paragraph">
<p>A terp may implement any, all, or none of the functions on the list.
If the game requests an accelerated function which is not available, the request is ignored.
Therefore, the game <em>must</em> be sure that it only requests an accelerated function at an address which actually matches the requested function.</p>
</div>
<div class="paragraph">
<p>Some functions may require values (or addresses) which are compiled into the game file, or otherwise stored by the game.
The interpreter maintains a table of these parameters&#8201;&#8212;&#8201;whichever ones are needed by the functions it supports.
All parameters in the table are initially zero; the game may supply values as needed.</p>
</div>
<div class="paragraph">
<p>The set of active acceleration requests, and the values in the parameter table, are <em>not</em> part of the saved-game state.</p>
</div>
<div class="paragraph">
<p>The behavior of an accelerated function is somewhat limited.
The state of the VM during the function is not defined, so there is no way for an accelerated function to call a normal VM function.
The normal printing mechanism (as in the <code>streamchar</code> opcode, etc) is not available, since that can call VM functions via the filter I/O system.<sup class="footnote">[<a id="_footnoteref_13" class="footnote" href="#_footnotedef_13" title="View footnote.">13</a>]</sup></p>
</div>
<div class="paragraph">
<p>Errors encountered during an accelerated function will be displayed to the user by some convenient means.
For example, an interpreter may send the error message to the current Glk output stream.
However, the terp may have no recourse but to invoke a <em>fatal</em> error.
(For example, if there is no current Glk output stream.)
Therefore, accelerated functions are defined with no error conditions that must be recoverable.</p>
</div>
<div class="paragraph">
<p>These opcodes were added in Glulx version 3.1.1.
Since a 3.1.1 game file ought to run in a 3.1.0 interpreter, you <em>may not</em> use these opcodes without first testing the <code>Acceleration</code> gestalt selector.
If it returns zero, your game is running on a 3.1.0 terp (or earlier), and it is your responsibility to avoid executing these opcodes.<sup class="footnote">[<a id="_footnoteref_14" class="footnote" href="#_footnotedef_14" title="View footnote.">14</a>]</sup></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">accelfunc L1 L2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Request that the VM function with address L2 be replaced by the accelerated function whose number is L1.
If L1 is zero, the acceleration for address L2 is cancelled.</p>
</div>
<div class="paragraph">
<p>If the terp does not offer accelerated function L1, this does nothing.</p>
</div>
<div class="paragraph">
<p>If you request acceleration at an address which is already accelerated, the previous request is cancelled before the new one is considered.
If you cancel at an unaccelerated address, nothing happens.</p>
</div>
<div class="paragraph">
<p>A given accelerated function L1 may replace several VM functions (at different addresses) at the same time.
Each request is considered separate, and must be cancelled separately.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">accelparam L1 L2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Store the value L2 in the parameter table at position L1.
If the terp does not know about parameter L1, this does nothing.</p>
</div>
<div class="paragraph">
<p>The list of accelerated functions is as follows.
They are defined as if in Inform 6 source code.
(Consider Inform&#8217;s &#8220;strict&#8221; mode to be off, for the purposes of operators such as <code>.&amp;</code> and <code>-&#8288;-&#8288;&gt;</code>.)
ERROR() represents code which displays an error, as described above.</p>
</div>
<div class="paragraph">
<p>(Functions may be added to this list in future versions of the Glulx spec.
Existing functions will not be removed or altered.
Functions and parameters numbered 0x1100 to 0x11FF are reserved for extension projects by Dannii Willis.
These are not documented here.
See <a href="#_glulx_and_other_if_systems">Glulx and Other IF Systems</a>.</p>
</div>
<div class="paragraph">
<p>Note that functions 2 through 7 are deprecated; they behave badly if the Inform 6 NUM_ATTR_BYTES option (parameter 7) is changed from its default value (7).
They will not be removed, but new games should use functions 8 through 13 instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-inform" data-lang="inform">Constant PARAM_0_classes_table = #classes_table;
Constant PARAM_1_indiv_prop_start = INDIV_PROP_START;
Constant PARAM_2_class_metaclass = Class;
Constant PARAM_3_object_metaclass = Object;
Constant PARAM_4_routine_metaclass = Routine;
Constant PARAM_5_string_metaclass = String;
Constant PARAM_6_self = #globals_array + WORDSIZE * #g$self;
Constant PARAM_7_num_attr_bytes = NUM_ATTR_BYTES;
Constant PARAM_8_cpv__start = #cpv__start;

! OBJ_IN_CLASS: utility function; implements "obj in Class".
[ OBJ_IN_CLASS obj;
  return ((obj + 13 + PARAM_7_num_attr_bytes)--&gt;0
    == PARAM_2_class_metaclass);
];

! FUNC_1_Z__Region: implements Z__Region() as of Inform 6.31.
[ FUNC_1_Z__Region addr
  tb endmem; ! locals
  if (addr&lt;36) rfalse;
  @getmemsize endmem;
  @jgeu addr endmem?outrange;  ! branch if addr &gt;= endmem (unsigned)
  tb=addr-&gt;0;
  if (tb &gt;= $E0) return 3;
  if (tb &gt;= $C0) return 2;
  if (tb &gt;= $70 &amp;&amp; tb &lt;= $7F &amp;&amp; addr &gt;= (0--&gt;2)) return 1;
.outrange;
  rfalse;
];

! FUNC_2_CP__Tab: implements CP__Tab() as of Inform 6.31.
[ FUNC_2_CP__Tab obj id
  otab max res; ! locals
  if (FUNC_1_Z__Region(obj)~=1) {
    ERROR("[** Programming error: tried to find the ~.~ of (something) **]");
    rfalse;
  }
  otab = obj--&gt;4;
  if (otab == 0) return 0;
  max = otab--&gt;0;
  otab = otab+4;
  @binarysearch id 2 otab 10 max 0 0 res;
  return res;
];

! FUNC_3_RA__Pr: implements RA__Pr() as of Inform 6.31.
[ FUNC_3_RA__Pr obj id
  cla prop ix; ! locals
  if (id &amp; $FFFF0000) {
    cla = PARAM_0_classes_table--&gt;(id &amp; $FFFF);
    if (~~FUNC_5_OC__Cl(obj, cla)) return 0;
    @ushiftr id 16 id;
    obj = cla;
  }
  prop = FUNC_2_CP__Tab(obj, id);
  if (prop==0) return 0;
  if (OBJ_IN_CLASS(obj) &amp;&amp; cla == 0) {
    if (id &lt; PARAM_1_indiv_prop_start
        || id &gt;= PARAM_1_indiv_prop_start+8)
      return 0;
  }
  if (PARAM_6_self--&gt;0 ~= obj) {
    @aloadbit prop 72 ix;
    if (ix) return 0;
  }
  return prop--&gt;1;
];

! FUNC_4_RL__Pr: implements RL__Pr() as of Inform 6.31.
[ FUNC_4_RL__Pr obj id
  cla prop ix; ! locals
  if (id &amp; $FFFF0000) {
    cla = PARAM_0_classes_table--&gt;(id &amp; $FFFF);
    if (~~FUNC_5_OC__Cl(obj, cla)) return 0;
    @ushiftr id 16 id;
    obj = cla;
  }
  prop = FUNC_2_CP__Tab(obj, id);
  if (prop==0) return 0;
  if (OBJ_IN_CLASS(obj) &amp;&amp; cla == 0) {
    if (id &lt; PARAM_1_indiv_prop_start
        || id &gt;= PARAM_1_indiv_prop_start+8)
      return 0;
  }
  if (PARAM_6_self--&gt;0 ~= obj) {
    @aloadbit prop 72 ix;
    if (ix) return 0;
  }
  @aloads prop 1 ix;
  return WORDSIZE * ix;
];

! FUNC_5_OC__Cl: implements OC__Cl() as of Inform 6.31.
[ FUNC_5_OC__Cl obj cla
  zr jx inlist inlistlen; ! locals
  zr = FUNC_1_Z__Region(obj);
  if (zr == 3) {
    if (cla == PARAM_5_string_metaclass) rtrue;
    rfalse;
  }
  if (zr == 2) {
    if (cla == PARAM_4_routine_metaclass) rtrue;
    rfalse;
  }
  if (zr ~= 1) rfalse;
  if (cla == PARAM_2_class_metaclass) {
    if (OBJ_IN_CLASS(obj)
      || obj == PARAM_2_class_metaclass or PARAM_5_string_metaclass
         or PARAM_4_routine_metaclass or PARAM_3_object_metaclass)
      rtrue;
    rfalse;
  }
  if (cla == PARAM_3_object_metaclass) {
    if (OBJ_IN_CLASS(obj)
      || obj == PARAM_2_class_metaclass or PARAM_5_string_metaclass
         or PARAM_4_routine_metaclass or PARAM_3_object_metaclass)
      rfalse;
    rtrue;
  }
  if (cla == PARAM_5_string_metaclass or PARAM_4_routine_metaclass)
    rfalse;
  if (~~OBJ_IN_CLASS(cla)) {
    ERROR("[** Programming error: tried to apply 'ofclass' with non-class **]");
    rfalse;
  }
  inlist = FUNC_3_RA__Pr(obj, 2);
  if (inlist == 0) rfalse;
  inlistlen = FUNC_4_RL__Pr(obj, 2) / WORDSIZE;
  for (jx=0 : jx&lt;inlistlen : jx++) {
    if (inlist--&gt;jx == cla) rtrue;
  }
  rfalse;
];

! FUNC_6_RV__Pr: implements RV__Pr() as of Inform 6.31.
[ FUNC_6_RV__Pr obj id
  addr; ! locals
  addr = FUNC_3_RA__Pr(obj, id);
  if (addr == 0) {
    if (id &gt; 0 &amp;&amp; id &lt; PARAM_1_indiv_prop_start) {
      return PARAM_8_cpv__start--&gt;id;
    }
    ERROR("[** Programming error: tried to read (something) **]");
    return 0;
  }
  return addr--&gt;0;
];

! FUNC_7_OP__Pr: implements OP__Pr() as of Inform 6.31.
[ FUNC_7_OP__Pr obj id
  zr; ! locals
  zr = FUNC_1_Z__Region(obj);
  if (zr == 3) {
    if (id == print or print_to_array) rtrue;
    rfalse;
  }
  if (zr == 2) {
    if (id == call) rtrue;
    rfalse;
  }
  if (zr ~= 1) rfalse;
  if (id &gt;= PARAM_1_indiv_prop_start
      &amp;&amp; id &lt; PARAM_1_indiv_prop_start+8) {
    if (OBJ_IN_CLASS(obj)) rtrue;
  }
  if (FUNC_3_RA__Pr(obj, id) ~= 0)
    rtrue;
  rfalse;
];

! FUNC_8_CP__Tab: implements CP__Tab() as of Inform 6.33.
[ FUNC_8_CP__Tab obj id
  otab max res; ! locals
  if (FUNC_1_Z__Region(obj)~=1) {
    ERROR("[** Programming error: tried to find the ~.~ of (something) **]");
    rfalse;
  }
  otab = obj--&gt;(3+(PARAM_7_num_attr_bytes/4));
  if (otab == 0) return 0;
  max = otab--&gt;0;
  otab = otab+4;
  @binarysearch id 2 otab 10 max 0 0 res;
  return res;
];

! FUNC_9_RA__Pr: implements RA__Pr() as of Inform 6.33.
[ FUNC_9_RA__Pr obj id
  cla prop ix; ! locals
  if (id &amp; $FFFF0000) {
    cla = PARAM_0_classes_table--&gt;(id &amp; $FFFF);
    if (~~FUNC_11_OC__Cl(obj, cla)) return 0;
    @ushiftr id 16 id;
    obj = cla;
  }
  prop = FUNC_8_CP__Tab(obj, id);
  if (prop==0) return 0;
  if (OBJ_IN_CLASS(obj) &amp;&amp; cla == 0) {
    if (id &lt; PARAM_1_indiv_prop_start
        || id &gt;= PARAM_1_indiv_prop_start+8)
      return 0;
  }
  if (PARAM_6_self--&gt;0 ~= obj) {
    @aloadbit prop 72 ix;
    if (ix) return 0;
  }
  return prop--&gt;1;
];

! FUNC_10_RL__Pr: implements RL__Pr() as of Inform 6.33.
[ FUNC_10_RL__Pr obj id
  cla prop ix; ! locals
  if (id &amp; $FFFF0000) {
    cla = PARAM_0_classes_table--&gt;(id &amp; $FFFF);
    if (~~FUNC_11_OC__Cl(obj, cla)) return 0;
    @ushiftr id 16 id;
    obj = cla;
  }
  prop = FUNC_8_CP__Tab(obj, id);
  if (prop==0) return 0;
  if (OBJ_IN_CLASS(obj) &amp;&amp; cla == 0) {
    if (id &lt; PARAM_1_indiv_prop_start
        || id &gt;= PARAM_1_indiv_prop_start+8)
      return 0;
  }
  if (PARAM_6_self--&gt;0 ~= obj) {
    @aloadbit prop 72 ix;
    if (ix) return 0;
  }
  @aloads prop 1 ix;
  return WORDSIZE * ix;
];

! FUNC_11_OC__Cl: implements OC__Cl() as of Inform 6.33.
[ FUNC_11_OC__Cl obj cla
  zr jx inlist inlistlen; ! locals
  zr = FUNC_1_Z__Region(obj);
  if (zr == 3) {
    if (cla == PARAM_5_string_metaclass) rtrue;
    rfalse;
  }
  if (zr == 2) {
    if (cla == PARAM_4_routine_metaclass) rtrue;
    rfalse;
  }
  if (zr ~= 1) rfalse;
  if (cla == PARAM_2_class_metaclass) {
    if (OBJ_IN_CLASS(obj)
      || obj == PARAM_2_class_metaclass or PARAM_5_string_metaclass
         or PARAM_4_routine_metaclass or PARAM_3_object_metaclass)
      rtrue;
    rfalse;
  }
  if (cla == PARAM_3_object_metaclass) {
    if (OBJ_IN_CLASS(obj)
      || obj == PARAM_2_class_metaclass or PARAM_5_string_metaclass
         or PARAM_4_routine_metaclass or PARAM_3_object_metaclass)
      rfalse;
    rtrue;
  }
  if (cla == PARAM_5_string_metaclass or PARAM_4_routine_metaclass)
    rfalse;
  if (~~OBJ_IN_CLASS(cla)) {
    ERROR("[** Programming error: tried to apply 'ofclass' with non-class **]");
    rfalse;
  }
  inlist = FUNC_9_RA__Pr(obj, 2);
  if (inlist == 0) rfalse;
  inlistlen = FUNC_10_RL__Pr(obj, 2) / WORDSIZE;
  for (jx=0 : jx&lt;inlistlen : jx++) {
    if (inlist--&gt;jx == cla) rtrue;
  }
  rfalse;
];

! FUNC_12_RV__Pr: implements RV__Pr() as of Inform 6.33.
[ FUNC_12_RV__Pr obj id
  addr; ! locals
  addr = FUNC_9_RA__Pr(obj, id);
  if (addr == 0) {
    if (id &gt; 0 &amp;&amp; id &lt; PARAM_1_indiv_prop_start) {
      return PARAM_8_cpv__start--&gt;id;
    }
    ERROR("[** Programming error: tried to read (something) **]");
    return 0;
  }
  return addr--&gt;0;
];

! FUNC_13_OP__Pr: implements OP__Pr() as of Inform 6.33.
[ FUNC_13_OP__Pr obj id
  zr; ! locals
  zr = FUNC_1_Z__Region(obj);
  if (zr == 3) {
    if (id == print or print_to_array) rtrue;
    rfalse;
  }
  if (zr == 2) {
    if (id == call) rtrue;
    rfalse;
  }
  if (zr ~= 1) rfalse;
  if (id &gt;= PARAM_1_indiv_prop_start
      &amp;&amp; id &lt; PARAM_1_indiv_prop_start+8) {
    if (OBJ_IN_CLASS(obj)) rtrue;
  }
  if (FUNC_9_RA__Pr(obj, id) ~= 0)
    rtrue;
  rfalse;
];</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_miscellaneous"><a class="anchor" href="#_miscellaneous"></a>2.18. Miscellaneous</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">nop</code></pre>
</div>
</div>
<div class="paragraph">
<p>Do nothing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">gestalt L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Test the Gestalt selector number L1, with optional extra argument L2, and store the result in S1.
If the selector is not known, store zero.</p>
</div>
<div class="paragraph">
<p>The reasoning behind the design of a Gestalt system is, I hope, too obvious to explain.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This list of Gestalt selectors has nothing to do with the list in the Glk library.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The list of L1 selectors is as follows.
Note that if a selector does not mention L2, you should always set that argument to zero.<sup class="footnote">[<a id="_footnoteref_15" class="footnote" href="#_footnotedef_15" title="View footnote.">15</a>]</sup></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GlulxVersion</code> (0): Returns the version of the Glulx spec which the interpreter implements.
The upper 16 bits of the value contain a major version number; the next 8 bits contain a minor version number; and the lowest 8 bits contain an even more minor version number, if any.
This specification is version 3.1.2, so a terp implementing it would return 0x00030102.
I will try to maintain the convention that minor version changes are backwards compatible, and subminor version changes are backwards and forwards compatible.</p>
</li>
<li>
<p><code>TerpVersion</code> (1): Returns the version of the interpreter.
The format is the same as the <code>GlulxVersion</code>.<sup class="footnote">[<a id="_footnoteref_16" class="footnote" href="#_footnotedef_16" title="View footnote.">16</a>]</sup></p>
</li>
<li>
<p><code>ResizeMem</code> (2): Returns 1 if the terp has the potential to resize the memory map, with the <code>setmemsize</code> opcode.
If this returns 0, <code>setmemsize</code> will always fail.<sup class="footnote">[<a id="_footnoteref_17" class="footnote" href="#_footnotedef_17" title="View footnote.">17</a>]</sup></p>
</li>
<li>
<p><code>Undo</code> (3): Returns 1 if the terp has the potential to undo.
If this returns 0, saveundo and restoreundo will always fail.</p>
</li>
<li>
<p><code>IOSystem</code> (4): Returns 1 if the terp supports the I/O system given in L2.
(The constants are the same as for the <code>setiosys</code> opcode: 0 for null, 1 for filter, 2 for Glk, 20 for FyreVM. 0 and 1 will always succeed.)</p>
</li>
<li>
<p><code>Unicode</code> (5): Returns 1 if the terp supports Unicode operations.
These are: the E2 Unicode string type; the 04 and 05 string node types (in compressed strings); the <code>streamunichar</code> opcode; the type-14 call stub.
If the <code>Unicode</code> selector returns 0, encountering any of these will cause a fatal interpreter error.</p>
</li>
<li>
<p><code>MemCopy</code> (6): Returns 1 if the interpreter supports the <code>mzero</code> and <code>mcopy</code> opcodes.
(This must true for any terp supporting Glulx 3.1.)</p>
</li>
<li>
<p><code>MAlloc</code> (7): Returns 1 if the interpreter supports the <code>malloc</code> and <code>mfree</code> opcodes.
(If this is true, <code>MemCopy</code> and <code>ResizeMem</code> must also both be true, so there is no need to check all three.)</p>
</li>
<li>
<p><code>MAllocHeap</code> (8): Returns the start address of the heap.
This is the value that getmemsize had when the first memory block was allocated.
If the heap is not active (no blocks are extant), this returns zero.</p>
</li>
<li>
<p><code>Acceleration</code> (9): Returns 1 if the interpreter supports the <code>accelfunc</code> and <code>accelparam</code> opcodes.
(This must true for any terp supporting Glulx 3.1.1.)</p>
</li>
<li>
<p><code>AccelFunc</code> (10): Returns 1 if the terp implements the accelerated function given in L2.</p>
</li>
<li>
<p><code>Float</code> (11): Returns 1 if the interpreter supports the floating-point arithmetic opcodes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Selectors 0x1000 to 0x10FF are reserved for use by FyreVM.
Selectors 0x1100 to 0x11FF are reserved for extension projects by Dannii Willis.
Selectors 0x1200 to 0x12FF are reserved for iOS extension features by Andrew Plotkin.
These are not documented here.
See <a href="#_glulx_and_other_if_systems">Glulx and Other IF Systems</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Unicode selector is slightly redundant.
Since the Unicode operations exist in Glulx spec 3.0 and higher, you can get the same information by testing <code>GlulxVersion</code> against 0x00030000.
However, it&#8217;s clearer to have a separate selector.
Similarly, the <code>MemCopy</code> selector is true exactly when <code>GlulxVersion</code> is 0x00030100 or higher.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Unicode selector does <em>not</em> guarantee that your Glk library supports Unicode.
For that, you must check the Glk gestalt selector <code>gestalt_Unicode</code>.
If the Glk library is non-Unicode, the Glulx Unicode operations are still legal; however, Unicode characters (beyond FF) will be printed as 3F (&#8220;?&#8221;).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">debugtrap L1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Interrupt execution to do something interpreter-specific with L1.
If the interpreter has nothing in mind, it should halt with a visible error message.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is intended for use by debugging interpreters.
The program might be sprinkled with consistency tests, set to call <code>debugtrap</code> if an assertion failed.
The interpreter could then be set to halt, display a warning, or ignore the <code>debugtrap</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This should <em>not</em> be used as an arbitrary interpreter trap-door in a finished (non-debugging) program.
If you really want to add interpreter functionality to your program, and you&#8217;re willing to support an alternate interpreter to run it, you should add an entirely new opcode.
There are still 2^28 of them available, give or take.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">glk L1 L2 S1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Call the Glk API function whose identifier is L1, passing in L2 arguments.
The return value is stored at S1.
(If the Glk function has no return value, zero is stored at S1.)</p>
</div>
<div class="paragraph">
<p>The arguments are passed on the stack, last argument pushed first, just as for the call opcode.</p>
</div>
<div class="paragraph">
<p>Arguments should be represented in the obvious way.
Integers and character are passed as integers.
Glk opaque objects are passed as integer identifiers, with zero representing NULL.
Strings and Unicode strings are passed as the addresses of Glulx string objects (see <a href="#_strings">section 1.6.1, &#8220;Strings&#8221;</a>.)
References to values are passed by their addresses.
Arrays are passed by their addresses; note that an array argument, unlike a string argument, is always followed by an array length argument.</p>
</div>
<div class="paragraph">
<p>Reference arguments require more explanation.
A reference to an integer or opaque object is the address of a 32-bit value (which, being in main memory, does not have to be aligned, but must be big-endian.)
Alternatively, the value -1 (FFFFFFFF) may be passed; this is a special case, which means that the value is read from or written to the stack.<sup class="footnote">[<a id="_footnoteref_18" class="footnote" href="#_footnotedef_18" title="View footnote.">18</a>]</sup>
Arguments are always evaluated left to right, which means that input arguments are popped from the stack first-topmost, but output arguments are pushed on last-topmost.</p>
</div>
<div class="paragraph">
<p>A reference to a Glk structure is the address of an array of 32-bit values in main memory.
Again, -1 means that all the values are written to the stack.
Also again, an input structure is popped off first-topmost, and an output structure is pushed on last-topmost.</p>
</div>
<div class="paragraph">
<p>All stack input references (-1 addresses) are popped after the Glk argument list is popped.<sup class="footnote">[<a id="_footnoteref_19" class="footnote" href="#_footnotedef_19" title="View footnote.">19</a>]</sup>
Stack output references are pushed after the Glk call, but before the S1 result value is stored.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The difference between strings and character arrays is somewhat confusing.
These are the same type in the C Glk API, but different in Glulx.
Calls such as <code>glk_put_buffer()</code> and <code>glk_request_line_event()</code> take character arrays; this is the address of a byte array containing character values, followed by an integer array length.
The byte array itself has neither a length field or a terminator.
In contrast, calls such as <code>glk_put_string()</code> and <code>glk_fileref_create_by_name()</code> take string arguments, which must be unencoded Glulx string objects.<sup class="footnote">[<a id="_footnoteref_20" class="footnote" href="#_footnotedef_20" title="View footnote.">20</a>]</sup>
An unencoded Glulx string object is nearly a byte array, but not quite; it has an E0 byte at the beginning and a zero byte at the end.
Similarly, calls such as <code>glk_put_string_uni()</code> take unencoded (E2) Unicode objects.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_assembly_language"><a class="anchor" href="#_assembly_language"></a>2.19. Assembly Language</h3>
<div class="paragraph">
<p>The format used by Inform is acceptable for now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">@opcode [ op op op ... ] ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where each &#8220;op&#8221; is a constant, the name of a local variable, the name of a global variable, or &#8220;sp&#8221; (for stack push/pop modes).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It would be convenient to have a one-line form for the opcodes that pass arguments on the stack (<code>call</code> and <code>glk</code>).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To make life a little easier for cross-platform I6 code, Inform accepts the macro &#8220;<code>@push val</code>&#8221; for &#8220;<code>@copy val sp</code>&#8221;, and &#8220;<code>@pull val</code>&#8221; for &#8220;<code>@copy sp val</code>&#8221;.
Supporting these forms is recommended.</p>
</div>
<div class="paragraph">
<p>You can synthesize opcodes that the compiler does not know about:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">@"FlagsCount:Code" [ op op op ... ] ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The optional Flags can include &#8220;S&#8221; if the last operand is a store; &#8220;SS&#8221; if the last two operands are stores; &#8220;B&#8221; for branch format; &#8220;R&#8221; if execution never continues after the opcode.
The Count is the number of arguments (0 to 9).
The Code is a decimal integer representing the opcode number.
So these two lines generate the same code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-glulx" data-lang="glulx">@add x 1 y;
@"S3:16" x 1 y;</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;because the <code>@add</code> opcode has number 16 (decimal), and has format <code>@add L1 L2 S1</code>.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. Silly, perhaps, but I like simple base cases.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. Because I couldn&#8217;t explain it if I tried. Follow the rules; they work.
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. Note that the game can change which table the terp is using, with the <code>setstringtbl</code> opcode. See <a href="#Output">section 2.11, &#8220;Output&#8221;</a>.
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. We delicately elide the subject of Fortran. And rule-based property algebras.
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. There will, of course, be an odd number of nodes, and (N+1)/2 of them will be leaves.
</div>
<div class="footnote" id="_footnotedef_6">
<a href="#_footnoteref_6">6</a>. This odd hiccup is inherited from the Z-machine. Inform uses it heavily for code optimization.
</div>
<div class="footnote" id="_footnotedef_7">
<a href="#_footnoteref_7">7</a>. Indeed, there is no well-defined notion of where a function ends.
</div>
<div class="footnote" id="_footnotedef_8">
<a href="#_footnoteref_8">8</a>. The VM&#8217;s heap state is not stored in its own memory map. So, unlike the familiar C heap, you cannot damage it by writing outside valid blocks.
</div>
<div class="footnote" id="_footnotedef_9">
<a href="#_footnoteref_9">9</a>. In other words, passing a float value to an integer arithmetic opcode will operate on the IEEE-754-encoded 32-bit value. Such an operation would be deterministic, albeit mathematically meaningless. The same is true for passing an integer to a float opcode.
</div>
<div class="footnote" id="_footnotedef_10">
<a href="#_footnoteref_10">10</a>. Speaking of special cases: I have tried to describe all the important ones for these operations. However, you should also consult the Glulxercise unit test (available on the Glulx web site). Consider it definitive if this document is unclear.
</div>
<div class="footnote" id="_footnotedef_11">
<a href="#_footnoteref_11">11</a>. These are outrageously CISC for an hardware CPU, but easy enough to add to a software terp; and taking advantage of them can speed up a program considerably. Advent, under the Inform library, runs 15-20% faster when property-table lookup is handled with a binary-search opcode instead of Inform code. A similar change in the dictionary lookup trims another percent or so.
</div>
<div class="footnote" id="_footnotedef_12">
<a href="#_footnoteref_12">12</a>. Yes, this is even more outrageously CISC than the search opcodes.
</div>
<div class="footnote" id="_footnotedef_13">
<a href="#_footnoteref_13">13</a>. Not that I/O functions are likely to be worth accelerating in any case.
</div>
<div class="footnote" id="_footnotedef_14">
<a href="#_footnoteref_14">14</a>. Of course, the way the opcodes are defined should ensure that skipping them does not affect the behavior of your game.
</div>
<div class="footnote" id="_footnotedef_15">
<a href="#_footnoteref_15">15</a>. This will ensure future compatibility, in case the selector definition is extended.
</div>
<div class="footnote" id="_footnotedef_16">
<a href="#_footnoteref_16">16</a>. Each interpreter has its own version numbering system, defined by its author, so this information is not terribly useful. But it is convenient for the game to be able to display it, in case the player is capturing version information for a bug report.
</div>
<div class="footnote" id="_footnotedef_17">
<a href="#_footnoteref_17">17</a>. But remember that <code>setmemsize</code> might fail in any case.
</div>
<div class="footnote" id="_footnotedef_18">
<a href="#_footnoteref_18">18</a>. The convention that &#8220;address&#8221; -1 refers to the stack is a feature of the Glk invocation mechanism; it applies only to Glk arguments. It is <em>not</em> part of the general Glulx definition. When instruction operands are being evaluated, -1 has no special meaning. This includes the L1, L2, and S1 arguments of the <code>glk</code> opcode.
</div>
<div class="footnote" id="_footnotedef_19">
<a href="#_footnoteref_19">19</a>. This should be obvious, since the -1 occurs <em>in</em> the Glk argument list.
</div>
<div class="footnote" id="_footnotedef_20">
<a href="#_footnoteref_20">20</a>. Previous versions of this spec said that string arguments could be unencoded <em>or encoded</em> string objects. This use of encoded strings has never been supported, however, and it is withdrawn from the spec.
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 3.1.2<br>
</div>
</div>
</body>
</html>